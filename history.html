<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„Ø§Øª - LifeBand</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .history-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px; }
        .history-card { 
            background: var(--glass); border: 1px solid var(--glass-border); 
            padding: 20px; border-radius: 18px; position: relative;
            transition: 0.3s; border-right: 5px solid #10b981;
        }
        .history-card:hover { transform: translateY(-5px); }
        .card-date { font-size: 12px; opacity: 0.6; display: block; margin-top: 10px; }
        .done-tag { color: #10b981; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body class="page-fade">
    <div class="bg-animation"></div>
    
    <div class="container" id="main-layout">

        <main style="padding: 40px 0;">
            <h2 data-i18n="history_title">ğŸ“‹ Ø³Ø¬Ù„Ùƒ Ø§Ù„Ø¨Ø·ÙˆÙ„ÙŠ</h2>
            <div id="historyList" class="history-grid">
                </div>
        </main>

    </div>

    <script type="module">
        import { injectLayout } from './js/layout.js';
        import { auth, db } from './js/firebase-config.js';
        import { ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯ (Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ÙÙˆØªØ±)
        injectLayout();

        // 2. ØªØ±Ø¬Ù…Ø§Øª Ø®Ø§ØµØ© Ø¨Ù…Ø­ØªÙˆÙ‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ÙÙ‚Ø·
        const pageTranslations = {
            ar: { done: "ØªÙ…Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­", empty: "Ù„Ù… ØªÙ‚Ù… Ø¨Ù…Ø¨Ø§Ø´Ø±Ø© Ø£ÙŠ Ø­Ø§Ù„Ø§Øª Ø¨Ø¹Ø¯." },
            en: { done: "Successfully Responded", empty: "You haven't responded to any cases yet." }
        };

        // 3. Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø¨ØªÙ†Ø³ÙŠÙ‚ Cards
        onAuthStateChanged(auth, (user) => {
            if (user) {
                onValue(ref(db, 'reports'), (snapshot) => {
                    const list = document.getElementById('historyList');
                    const lang = localStorage.getItem('preferred_lang') || 'ar';
                    list.innerHTML = "";
                    
                    snapshot.forEach((child) => {
                        const data = child.val();
                        // Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªÙŠ Ø¨Ø§Ø´Ø±Ù‡Ø§ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø¹Ù ÙÙ‚Ø·
                        if (data.rescuerId === user.uid) {
                            const date = new Date(data.timestamp).toLocaleString(lang === 'ar' ? 'ar-SA' : 'en-US');
                            const card = document.createElement('div');
                            card.className = 'history-card';
                            card.innerHTML = `
                                <div class="done-tag">âœ… ${pageTranslations[lang].done}</div>
                                <h3 style="margin: 10px 0;">${data.patientName}</h3>
                                <p style="font-size: 14px; opacity: 0.8;">${data.diagnosis}</p>
                                <span class="card-date">${date}</span>
                            `;
                            list.appendChild(card);
                        }
                    });

                    if (!list.innerHTML) {
                        list.innerHTML = `<p>${pageTranslations[lang].empty}</p>`;
                    }
                });
            } else {
                window.location.href = "login.html";
            }
        });
    </script>
</body>
</html>