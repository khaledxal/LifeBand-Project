<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>البلاغات النشطة - LifeBand</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .reports-container { padding: 40px 20px; }
        .report-card { 
            background: var(--glass); 
            border: 1px solid var(--glass-border); 
            padding: 25px; 
            border-radius: 20px; 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-right: 6px solid #ef4444; /* لون أحمر للإشارة للحالة الطارئة */
            box-shadow: var(--card-shadow);
        }
        .report-info h3 { color: var(--primary); margin-bottom: 5px; }
        .respond-btn { background: #10b981 !important; width: auto !important; padding: 12px 30px !important; }
        
        @media (max-width: 600px) {
            .report-card { flex-direction: column; text-align: center; gap: 15px; }
        }
    </style>
</head>
<body class="page-fade">
    <div class="bg-animation"></div>

    <div class="container" id="main-layout">
        
        <main class="reports-container">
            <h2 data-i18n="reports_title">⚠️ البلاغات الحالية</h2>
            <div id="reportsList" style="margin-top: 25px;">
                </div>
        </main>

    </div>

    <script type="module">
        import { injectLayout } from './js/layout.js';
        import { auth, db } from './js/firebase-config.js';
        import { ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // 1. تشغيل الهيكل الموحد (سيقوم بإظهار روابط المتطوعين تلقائياً)
        injectLayout();

        // 2. ترجمات خاصة بمحتوى البلاغات
        const pageT = {
            ar: { btn_respond: "مباشرة الحالة", empty: "لا توجد بلاغات حالياً" },
            en: { btn_respond: "Respond Now", empty: "No active reports at the moment" }
        };

        const reportsList = document.getElementById('reportsList');

        // 3. جلب البلاغات النشطة "فقط" التي تنتظر مسعف
        onValue(ref(db, 'reports'), (snapshot) => {
            const lang = localStorage.getItem('preferred_lang') || 'ar';
            reportsList.innerHTML = "";
            
            if (!snapshot.exists()) {
                reportsList.innerHTML = `<p style="text-align:center; opacity:0.6;">${pageT[lang].empty}</p>`;
                return;
            }

            snapshot.forEach((child) => {
                const data = child.val();
                // نعرض فقط البلاغات التي حالتها "قيد الانتظار"
                if (data.status === "قيد الانتظار") {
                    const card = document.createElement('div');
                    card.className = 'report-card';
                    card.innerHTML = `
                        <div class="report-info">
                            <h3>${data.patientName || 'مريض مجهول'}</h3>
                            <p style="opacity: 0.8;">${data.diagnosis || 'تنبيه طارئ من سوار الحياة'}</p>
                            <small style="opacity: 0.5;">${new Date(data.timestamp).toLocaleTimeString(lang === 'ar' ? 'ar-SA' : 'en-US')}</small>
                        </div>
                        <button class="main-btn respond-btn" data-id="${child.key}">
                            ${pageT[lang].btn_respond}
                        </button>
                    `;
                    reportsList.appendChild(card);
                }
            });

            if (!reportsList.innerHTML) {
                reportsList.innerHTML = `<p style="text-align:center; opacity:0.6;">${pageT[lang].empty}</p>`;
            }
        });

        // 4. التعامل مع زر "مباشرة الحالة"
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('respond-btn')) {
                const reportId = e.target.getAttribute('data-id');
                const user = auth.currentUser;
                const lang = localStorage.getItem('preferred_lang') || 'ar';

                if (!user) {
                    alert(lang === 'ar' ? "يجب تسجيل الدخول أولاً" : "Please login first");
                    return;
                }

                try {
                    // تحديث حالة البلاغ في القاعدة وإضافة معرف المنقذ
                    await update(ref(db, `reports/${reportId}`), { 
                        status: "تمت المباشرة", 
                        rescuerId: user.uid 
                    });
                    
                    alert(lang === 'ar' ? "تم استلام الحالة، توجه للموقع فوراً ✅" : "Case accepted, proceed to location ✅");
                    // التوجه لصفحة السجل لمتابعة الحالات التي باشرها
                    window.location.href = "history.html";
                } catch (error) {
                    console.error("Error updating report:", error);
                }
            }
        });
    </script>
</body>
</html>