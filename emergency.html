<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeBand - حالة طوارئ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .emergency-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .ai-input-area { width: 100%; max-width: 500px; text-align: center; }
        .textarea-style { width: 100%; height: 120px; padding: 15px; border-radius: 15px; border: 1px solid var(--glass-border); background: var(--input-bg); color: var(--text-main); font-family: inherit; margin-bottom: 15px; resize: none; }
        .loading-spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="page-fade">
    <div class="bg-animation"></div>
    <div class="emergency-container">
        <div class="glass-card ai-input-area" id="mainBox">
            <h2 id="patientName" style="color: var(--primary); margin-bottom: 10px;">تحميل بيانات المريض...</h2>
            <p id="medicalSummary" style="font-size: 14px; opacity: 0.8; margin-bottom: 20px;"></p>
            
            <div id="inputSection">
                <p style="margin-bottom: 10px;">ما هي الأعراض أو الحالة الحالية؟</p>
                <textarea id="symptomInput" class="textarea-style" placeholder="مثلاً: المريض يشعر بضيق تنفس وتنميل في اليد اليسرى..."></textarea>
                <button id="analyzeBtn" class="main-btn">تحليل الحالة بواسطة AI</button>
                <div id="loader" class="loading-spinner"></div>
            </div>

            <div id="resultSection" style="display: none;">
                <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 15px; border-right: 5px solid #10b981; text-align: right;">
                    <h4 style="color: #10b981; margin-bottom: 10px;">إرشادات الذكاء الاصطناعي:</h4>
                    <p id="aiAdviceText" style="line-height: 1.6;"></p>
                </div>
                <p id="dbStatus" style="margin-top: 15px; font-weight: bold; color: var(--accent);"></p>
                <button onclick="location.reload()" class="main-btn" style="margin-top: 15px; background: var(--secondary);">حالة جديدة</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { ref, get, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const GEMINI_API_KEY = "AIzaSyBfaNgh-JQX25tK-6HMm9KDeXud5RhOnwg";
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('id');

        let patientData = null;

        if (userId) {
            get(ref(db, `patients/${userId}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    patientData = snapshot.val();
                    document.getElementById('patientName').innerText = patientData.name;
                    document.getElementById('medicalSummary').innerText = `التاريخ الطبي: ${patientData.diseases?.join('، ') || 'لا يوجد'}`;
                }
            });
        }

        async function getAiDiagnosis(symptoms) {
            const prompt = `أنت مساعد طبي طارئ ذكي. المريض: ${patientData.name}. 
            تاريخه الطبي: ${patientData.diseases?.join('، ')}. 
            الأعراض الحالية: ${symptoms}. 
            حلل الحالة وقدم إرشادات إسعافية فورية باللغة العربية واذكر إذا كانت الحالة تستدعي نقله للمستشفى فوراً.`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        document.getElementById('analyzeBtn').onclick = async () => {
            const symptoms = document.getElementById('symptomInput').value;
            if (!symptoms) return alert("يرجى وصف الحالة أولاً");

            document.getElementById('analyzeBtn').style.display = 'none';
            document.getElementById('loader').style.display = 'block';

            try {
                const advice = await getAiDiagnosis(symptoms);
                
                await push(ref(db, 'reports'), {
                    patientId: userId,
                    patientName: patientData.name,
                    diagnosis: advice,
                    symptoms: symptoms,
                    timestamp: new Date().toISOString(),
                    status: "قيد الانتظار"
                });

                document.getElementById('inputSection').style.display = 'none';
                document.getElementById('resultSection').style.display = 'block';
                document.getElementById('aiAdviceText').innerText = advice;
                document.getElementById('dbStatus').innerText = "✅ تم إرسال التقرير والتحليل للوحة الإدارة";
            } catch (err) {
                alert("خطأ: " + err.message);
                document.getElementById('analyzeBtn').style.display = 'block';
                document.getElementById('loader').style.display = 'none';
            }
        };
    </script>
</body>
</html>