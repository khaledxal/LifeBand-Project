<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeBand - Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .emergency-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .hold-circle {
            position: relative;
            width: 180px;
            height: 180px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background: var(--glass);
            border-radius: 50%;
            border: 2px solid var(--glass-border);
            transition: transform 0.2s;
        }
        .hold-circle:active { transform: scale(0.95); }
        .progress-ring { position: absolute; top: -5px; left: -5px; transform: rotate(-90deg); }
        .progress-ring__circle {
            stroke-dasharray: 565.48; /* 2 * PI * 90 */
            stroke-dashoffset: 565.48;
            transition: stroke-dashoffset 0.1s linear;
        }
        .alert-card {
            background: rgba(16, 185, 129, 0.1);
            border-right: 5px solid #10b981;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            animation: slideIn 0.5s ease forwards;
            opacity: 0;
        }
        @keyframes slideIn { from { transform: translateX(30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="page-fade">
    <div class="bg-animation"></div>
    
    <div class="emergency-container">
        <div id="triggerSection" class="glass-card" style="text-align: center; max-width: 400px; width: 100%;">
            <h2 style="margin-bottom: 30px;">Ù†Ø¸Ø§Ù… LifeBand Ù„Ù„Ø·ÙˆØ§Ø±Ø¦</h2>
            <div id="holdBtn" class="hold-circle" style="margin: 0 auto;">
                <span id="holdText" style="font-weight: bold; color: var(--text-main);">Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹<br>Ù„ÙØªØ­ Ø§Ù„Ù…Ù„Ù</span>
                <svg class="progress-ring" width="190" height="190">
                    <circle class="progress-ring__circle" stroke="#ef4444" stroke-width="10" fill="transparent" r="90" cx="95" cy="95"/>
                </svg>
            </div>
            <p style="margin-top: 20px; font-size: 14px; opacity: 0.7;">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙÙˆØ±ÙŠØ© Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©</p>
        </div>

        <div id="infoSection" class="glass-card" style="display: none; width: 100%; max-width: 600px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <h1 id="patientName" style="color: #ef4444;">ØªØ­Ù…ÙŠÙ„...</h1>
                <span id="patientBlood" style="background: #ef4444; color: white; padding: 5px 15px; border-radius: 20px;">--</span>
            </div>

            <div id="alertsContainer">
                <div class="alert-card" style="animation-delay: 0.2s;">âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦.</div>
                <div class="alert-card" style="animation-delay: 1.2s;">âœ… ØªÙ… Ø¥Ø´Ø¹Ø§Ø± Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© (Ø§Ù„Ø£Ù‡Ù„).</div>
                <div class="alert-card" style="animation-delay: 2.2s;">âœ… ØªÙ… ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø³ØªØ®Ø¯Ù…ÙŠ LifeBand Ø§Ù„Ù‚Ø±ÙŠØ¨ÙŠÙ†.</div>
            </div>

            <div id="medicalInstructions" style="background: var(--primary); color: white; padding: 20px; border-radius: 15px; margin-top: 20px;">
                <h3 style="margin-bottom: 10px;">ğŸ“‹ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø³Ø¹Ù:</h3>
                <div id="questionsList" style="margin-bottom: 15px; line-height: 1.8;"></div>
                <hr style="opacity: 0.3; margin-bottom: 15px;">
                <strong>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¬Ù„:</strong>
                <p id="actionText"></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('id');

        if (!userId) {
            document.body.innerHTML = "<h1 style='text-align:center; margin-top:50px;'>Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­</h1>";
        }

        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„
        let holdTimer;
        let progress = 0;
        const circle = document.querySelector('.progress-ring__circle');
        const offset = 565.48;
        const holdBtn = document.getElementById('holdBtn');

        const startHold = () => {
            holdTimer = setInterval(() => {
                progress += 2;
                circle.style.strokeDashoffset = offset - (progress / 100) * offset;
                if (progress >= 100) {
                    clearInterval(holdTimer);
                    activateEmergency();
                }
            }, 30);
        };

        const cancelHold = () => {
            clearInterval(holdTimer);
            progress = 0;
            circle.style.strokeDashoffset = offset;
        };

        holdBtn.addEventListener('mousedown', startHold);
        holdBtn.addEventListener('touchstart', startHold);
        window.addEventListener('mouseup', cancelHold);
        window.addEventListener('touchend', cancelHold);

        async function activateEmergency() {
            document.getElementById('triggerSection').style.display = 'none';
            document.getElementById('infoSection').style.display = 'block';
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
            const snapshot = await get(ref(db, 'patients/' + userId));
            if (snapshot.exists()) {
                const data = snapshot.val();
                document.getElementById('patientName').innerText = data.name;
                document.getElementById('patientBlood').innerText = "ÙØµÙŠÙ„Ø©: " + data.bloodType;
                
                generateMedicalLogic(data.diseases || []);
            }
        }

        function generateMedicalLogic(diseases) {
            const qList = document.getElementById('questionsList');
            const aText = document.getElementById('actionText');
            
            let questions = ["Ù‡Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Ø­Ø§Ù„Ø© ÙˆØ¹ÙŠ ØªØ§Ù…Ø©ØŸ", "Ù‡Ù„ ÙŠØªÙ†ÙØ³ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠØŸ"];
            let action = "Ø§Ø¨Ù‚Ù Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù‡Ø¯ÙˆØ¦Ù‡ Ø­ØªÙ‰ ÙˆØµÙˆÙ„ Ø§Ù„Ø¥Ø³Ø¹Ø§Ù.";

            if (diseases.includes("Ø§Ù„Ø³ÙƒØ±ÙŠ")) {
                questions.push("Ù‡Ù„ ÙŠØ´Ø¹Ø± Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ø¯ÙˆØ§Ø± Ø£Ùˆ ØªØ¹Ø±Ù‚ Ø¨Ø§Ø±Ø¯ØŸ");
                action = "Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ø¹ÙŠØ§Ù‹ØŒ Ø³Ø§Ø¹Ø¯Ù‡ Ø¹Ù„Ù‰ ØªÙ†Ø§ÙˆÙ„ Ø³ÙƒØ± Ø³Ø±ÙŠØ¹ Ø§Ù„Ø§Ù…ØªØµØ§Øµ. ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø¥ØºÙ…Ø§Ø¡ Ù„Ø§ ØªØ¹Ø·Ù‡ Ø´ÙŠØ¦Ø§Ù‹.";
            }
            if (diseases.includes("Ø§Ù„Ø¶ØºØ·")) {
                questions.push("Ù‡Ù„ ÙŠØ´Ø¹Ø± Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨ØµØ¯Ø§Ø¹ Ø´Ø¯ÙŠØ¯ Ø£Ùˆ Ø·Ù†ÙŠÙ†ØŸ");
                action = "Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙŠØ³ØªØ±ÙŠØ­ ÙÙŠ ÙˆØ¶Ø¹ÙŠØ© Ø´Ø¨Ù‡ Ø¬Ù„ÙˆØ³ (45 Ø¯Ø±Ø¬Ø©) ÙˆÙ‚Ù„Ù„ Ù…Ù† Ø§Ù„Ù…Ø¬Ù‡ÙˆØ¯ Ø§Ù„Ø¨Ø¯Ù†ÙŠ.";
            }

            qList.innerHTML = questions.map(q => `<div>â€¢ ${q}</div>`).join('');
            aText.innerText = action;
        }
    </script>
</body>
</html>