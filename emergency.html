<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeBand - Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .emergency-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .hold-circle {
            position: relative;
            width: 180px;
            height: 180px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background: var(--glass);
            border-radius: 50%;
            border: 2px solid var(--glass-border);
            transition: transform 0.2s;
        }
        .progress-ring { position: absolute; top: -5px; left: -5px; transform: rotate(-90deg); }
        .progress-ring__circle {
            stroke-dasharray: 565.48;
            stroke-dashoffset: 565.48;
            transition: stroke-dashoffset 0.1s linear;
        }
        .alert-card {
            background: rgba(16, 185, 129, 0.1);
            border-right: 5px solid #10b981;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            animation: slideIn 0.5s ease forwards;
            opacity: 0;
        }
        @keyframes slideIn { from { transform: translateX(30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© */
        .diag-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            transition: 0.3s;
        }
    </style>
</head>
<body class="page-fade">
    <div class="bg-animation"></div>
    
    <div class="emergency-container">
        <div id="triggerSection" class="glass-card" style="text-align: center; max-width: 400px; width: 100%;">
            <h2 style="margin-bottom: 30px;">Ù†Ø¸Ø§Ù… LifeBand Ù„Ù„Ø·ÙˆØ§Ø±Ø¦</h2>
            <div id="holdBtn" class="hold-circle" style="margin: 0 auto;">
                <span id="holdText" style="font-weight: bold; color: var(--text-main);">Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹<br>Ù„ÙØªØ­ Ø§Ù„Ù…Ù„Ù</span>
                <svg class="progress-ring" width="190" height="190">
                    <circle class="progress-ring__circle" stroke="#ef4444" stroke-width="10" fill="transparent" r="90" cx="95" cy="95"/>
                </svg>
            </div>
            <p style="margin-top: 20px; font-size: 14px; opacity: 0.7;">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙÙˆØ±ÙŠØ© Ù„Ù„Ù…Ø³Ø¹ÙÙŠÙ† ÙˆØ§Ù„Ø£Ù‡Ù„</p>
        </div>

        <div id="infoSection" class="glass-card" style="display: none; width: 100%; max-width: 600px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <h1 id="patientName" style="color: #ef4444;">ØªØ­Ù…ÙŠÙ„...</h1>
                <span id="patientBlood" style="background: #ef4444; color: white; padding: 5px 15px; border-radius: 20px;">--</span>
            </div>

            <div id="alertsContainer">
                <div class="alert-card" style="animation-delay: 0.2s;">âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ù„Ù„Ø¥Ø³Ø¹Ø§Ù.</div>
                <div class="alert-card" style="animation-delay: 1s;">âœ… ØªÙ… Ø¥Ø´Ø¹Ø§Ø± Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© (Ø§Ù„Ø£Ù‡Ù„).</div>
            </div>

            <div id="aiAssistant" style="background: var(--primary); color: white; padding: 25px; border-radius: 20px; margin-top: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span>ğŸš‘</span> Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ
                </h3>
                
                <div id="questionBox">
                    <p id="activeQuestion" style="font-size: 1.2rem; margin-bottom: 20px; line-height: 1.5; font-weight: 500;"></p>
                    <div style="display: flex; gap: 15px;">
                        <button id="btnYes" class="diag-btn" style="background: #10b981; color: white;">Ù†Ø¹Ù…</button>
                        <button id="btnNo" class="diag-btn" style="background: #ef4444; color: white;">Ù„Ø§</button>
                    </div>
                </div>

                <div id="finalActionBox" style="display: none;">
                    <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px; border-right: 4px solid #fff;">
                        <strong style="font-size: 1.1rem;">Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ø§Ø¬Ù„ Ù…Ù‚ØªØ±Ø­:</strong>
                        <p id="finalActionText" style="margin-top: 10px; font-size: 1.1rem; line-height: 1.6;"></p>
                    </div>
                    <button onclick="location.reload()" class="main-btn" style="margin-top: 20px; background: white; color: var(--primary);">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('id');

        if (!userId) {
            document.body.innerHTML = "<h1 style='text-align:center; margin-top:50px;'>Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­</h1>";
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„ ---
        let holdTimer;
        let progress = 0;
        const circle = document.querySelector('.progress-ring__circle');
        const offset = 565.48;
        const holdBtn = document.getElementById('holdBtn');

        const startHold = (e) => {
            e.preventDefault();
            holdTimer = setInterval(() => {
                progress += 2;
                circle.style.strokeDashoffset = offset - (progress / 100) * offset;
                if (progress >= 100) {
                    clearInterval(holdTimer);
                    activateEmergency();
                }
            }, 30);
        };

        const cancelHold = () => {
            clearInterval(holdTimer);
            progress = 0;
            circle.style.strokeDashoffset = offset;
        };

        holdBtn.addEventListener('mousedown', startHold);
        holdBtn.addEventListener('touchstart', startHold);
        window.addEventListener('mouseup', cancelHold);
        window.addEventListener('touchend', cancelHold);

        // --- Ù…Ù†Ø·Ù‚ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ ---
        let patientDiseases = [];

        async function activateEmergency() {
            document.getElementById('triggerSection').style.display = 'none';
            document.getElementById('infoSection').style.display = 'block';
            
            try {
                const snapshot = await get(ref(db, 'patients/' + userId));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    patientDiseases = data.diseases || [];
                    document.getElementById('patientName').innerText = data.name;
                    document.getElementById('patientBlood').innerText = "ÙØµÙŠÙ„Ø©: " + data.bloodType;
                    
                    startDiagnostic(); // Ø¨Ø¯Ø¡ Ø´Ø¬Ø±Ø© Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª
                }
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        function startDiagnostic() {
            // Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„ÙˆØ¹ÙŠ (Ø£Ø³Ø§Ø³ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª)
            askQuestion("Ù‡Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ø¹ÙŠ ÙˆÙŠØ³ØªØ¬ÙŠØ¨ Ù„ÙƒØŸ", 
                () => checkDiseasesLogic(), // Ù†Ø¹Ù… -> Ù†Ù†ØªÙ‚Ù„ Ù„ÙØ­Øµ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©
                "Ø¶Ø¹ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ ÙˆØ¶Ø¹ÙŠØ© Ø§Ù„Ø¥ÙØ§Ù‚Ø© (Ø¹Ù„Ù‰ Ø¬Ù†Ø¨Ù‡)ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙØ³Ù‡ØŒ ÙˆØ§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø¥Ù†Ø¹Ø§Ø´ Ø§Ù„Ù‚Ù„Ø¨ÙŠ (CPR) ÙÙˆØ±Ø§Ù‹ Ø¥Ø°Ø§ ØªÙˆÙ‚Ù Ø§Ù„Ù†Ø¨Ø¶." // Ù„Ø§
            );
        }

        function checkDiseasesLogic() {
            if (patientDiseases.includes("Ø§Ù„Ø³ÙƒØ±ÙŠ")) {
                askQuestion("Ù‡Ù„ ØªÙ„Ø§Ø­Ø¸ ØªØ¹Ø±Ù‚Ø§Ù‹ Ø¨Ø§Ø±Ø¯Ø§Ù‹ Ø£Ùˆ Ø´Ø­ÙˆØ¨Ø§Ù‹ Ø£Ùˆ Ø§Ø±ØªØ¹Ø§Ø´Ø§Ù‹ØŸ", 
                    "Ø§Ø´ØªØ¨Ø§Ù‡ Ù‡Ø¨ÙˆØ· Ø³ÙƒØ± Ø­Ø§Ø¯: Ø¥Ø°Ø§ ÙƒØ§Ù† ÙˆØ§Ø¹ÙŠØ§Ù‹ØŒ Ø£Ø¹Ø·Ù‡ Ø¹ØµÙŠØ± Ù…Ø­Ù„Ù‰ Ø£Ùˆ Ù…Ù„Ø¹Ù‚Ø© Ø¹Ø³Ù„ ÙÙˆØ±Ø§Ù‹. Ù„Ø§ ØªØ¹Ø·Ù Ø´ÙŠØ¦Ø§Ù‹ ÙÙŠ Ø­Ø§Ù„ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ÙˆØ¹ÙŠ Ø§Ù„Ø¬Ø²Ø¦ÙŠ.", // Ù†Ø¹Ù…
                    () => checkNextDisease("Ø§Ù„Ø³ÙƒØ±ÙŠ") // Ù„Ø§ -> ÙØ­Øµ Ø§Ù„Ù…Ø±Ø¶ Ø§Ù„ØªØ§Ù„ÙŠ
                );
            } else if (patientDiseases.includes("Ø§Ù„Ø±Ø¨Ùˆ")) {
                askQuestion("Ù‡Ù„ ÙŠØ¹Ø§Ù†ÙŠ Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ù† ØµÙÙŠØ± ÙÙŠ Ø§Ù„ØµØ¯Ø± Ø£Ùˆ ØµØ¹ÙˆØ¨Ø© Ø¨Ø§Ù„ØºØ© ÙÙŠ Ø§Ù„ØªÙ†ÙØ³ØŸ", 
                    "Ù†ÙˆØ¨Ø© Ø±Ø¨Ùˆ Ø­Ø§Ø¯Ø©: Ø³Ø§Ø¹Ø¯Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù„ÙˆØ³ Ø¨ÙˆØ¶Ø¹ÙŠØ© Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø®Ø§Ø® Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ (Ventalin) Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹.", 
                    () => checkNextDisease("Ø§Ù„Ø±Ø¨Ùˆ")
                );
            } else {
                showFinalResult("Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ø¹ÙŠ ÙˆÙ…Ø³ØªÙ‚Ø± Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ø¨Ù‚Ù Ø¨Ø¬Ø§Ù†Ø¨Ù‡ØŒ Ø±Ø§Ù‚Ø¨ ØªÙ†ÙØ³Ù‡ØŒ ÙˆØ§Ù†ØªØ¸Ø± ÙˆØµÙˆÙ„ ÙØ±Ù‚ Ø§Ù„Ø¥Ø³Ø¹Ø§Ù.");
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…ØµØ§Ø¨Ø§Ù‹ Ø¨Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø¶
        function checkNextDisease(lastChecked) {
            const remaining = patientDiseases.filter(d => d !== lastChecked);
            if (remaining.length > 0) {
                // Ù…Ù†Ø·Ù‚ Ø¥Ø¶Ø§ÙÙŠ Ù„Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ (Ù…Ø«Ù„ Ø§Ù„Ø¶ØºØ· Ø£Ùˆ Ø§Ù„Ù‚Ù„Ø¨)
                showFinalResult("Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ø³ØªÙ‚Ø± Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ ØªÙˆØ®ÙŠ Ø§Ù„Ø­Ø°Ø± ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ®Ù‡ Ø§Ù„Ø·Ø¨ÙŠ.");
            } else {
                showFinalResult("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ø±Ø§Ø¶ Ø·Ø§Ø±Ø¦Ø© ÙˆØ§Ø¶Ø­Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø¥Ø³Ø¹Ø§Ù.");
            }
        }

        function askQuestion(text, yesAction, noAction) {
            document.getElementById('activeQuestion').innerText = text;
            
            document.getElementById('btnYes').onclick = () => {
                if (typeof yesAction === "function") yesAction();
                else showFinalResult(yesAction);
            };
            
            document.getElementById('btnNo').onclick = () => {
                if (typeof noAction === "function") noAction();
                else showFinalResult(noAction);
            };
        }

        function showFinalResult(text) {
            document.getElementById('questionBox').style.display = 'none';
            document.getElementById('finalActionBox').style.display = 'block';
            document.getElementById('finalActionText').innerText = text;
        }
    </script>
</body>
</html>