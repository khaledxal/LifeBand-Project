<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeBand - تشخيص الخيارات الذكي</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .emergency-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .diagnostic-card { width: 100%; max-width: 550px; text-align: center; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }
        .option-btn { 
            padding: 15px; border: 2px solid var(--glass-border); border-radius: 12px; 
            background: var(--glass); color: var(--text-main); cursor: pointer; 
            font-weight: bold; transition: 0.3s; font-size: 15px;
        }
        .option-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .question-text { font-size: 1.3rem; line-height: 1.5; margin-bottom: 10px; min-height: 60px; }
        .step-indicator { font-size: 12px; opacity: 0.6; margin-bottom: 20px; display: block; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="page-fade">
    <div class="bg-animation"></div>
    <div class="emergency-container">
        <div class="glass-card diagnostic-card">
            <span class="step-indicator" id="stepCounter">السؤال رقم: 1</span>
            <div id="questionArea">
                <p class="question-text" id="activeQuestion">جاري بدء جلسة التشخيص...</p>
                <div id="loader" class="loader"></div>
                <div class="options-grid" id="optionsContainer">
                    </div>
            </div>

            <div id="finalResult" style="display: none;">
                <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 15px; border-right: 5px solid #10b981; text-align: right; margin-bottom: 20px;">
                    <h3 style="color: #10b981; margin-bottom: 10px;">النتيجة النهائية والتعامل:</h3>
                    <p id="resultText" style="line-height: 1.6;"></p>
                </div>
                <button onclick="saveAndExit()" class="main-btn">حفظ التقرير وإنهاء</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { ref, get, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const API_KEY = "AIzaSyBfaNgh-JQX25tK-6HMm9KDeXud5RhOnwg";
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('id');

        let history = [];
        let step = 1;
        let patientName = "المريض";

        if (userId) {
            get(ref(db, `patients/${userId}`)).then(s => { if(s.exists()) patientName = s.val().name; });
        }

        async function fetchNextStep(userChoice = "بدء التشخيص") {
            toggleLoader(true);
            const prompt = `أنت مساعد طبي طارئ. المريض هو ${patientName}. 
            يجب أن يكون ردك بتنسيق JSON فقط كالتالي:
            {"question": "نص السؤال هنا", "options": ["خيار1", "خيار2", "خيار3", "خيار4"], "isFinal": false}
            
            قواعد:
            1. إذا لم تتوصل لنتيجة، اجعل isFinal false وأعط سؤالاً جديداً و4 خيارات (قوي، خفيف، نعم، لا، إلخ).
            2. إذا وصلت للتشخيص النهائي، اجعل isFinal true وضع الإرشادات في حقل question والخيارات مصفوفة فارغة.
            3. المحادثة السابقة: ${JSON.stringify(history)}`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                const data = await res.json();
                const rawText = data.candidates[0].content.parts[0].text.replace(/```json|```/g, "");
                const result = JSON.parse(rawText);

                renderStep(result);
            } catch (e) { console.error("Error:", e); }
            toggleLoader(false);
        }

        function renderStep(data) {
            if (data.isFinal) {
                document.getElementById('questionArea').style.display = 'none';
                document.getElementById('finalResult').style.display = 'block';
                document.getElementById('resultText').innerText = data.question;
                return;
            }

            document.getElementById('activeQuestion').innerText = data.question;
            document.getElementById('stepCounter').innerText = `السؤال رقم: ${step}`;
            const container = document.getElementById('optionsContainer');
            container.innerHTML = "";

            data.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => {
                    history.push({ question: data.question, answer: opt });
                    step++;
                    fetchNextStep(opt);
                };
                container.appendChild(btn);
            });
        }

        function toggleLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
            document.getElementById('optionsContainer').style.opacity = show ? '0.3' : '1';
        }

        window.saveAndExit = async () => {
            await push(ref(db, 'reports'), {
                patientId: userId,
                patientName: patientName,
                diagnosis: document.getElementById('resultText').innerText,
                fullLog: history,
                timestamp: new Date().toISOString(),
                status: "قيد الانتظار"
            });
            location.href = "index.html";
        };

        // انطلاق الجلسة
        fetchNextStep();
    </script>
</body>
</html>