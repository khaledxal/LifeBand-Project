<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeBand - ุฅุฏุงุฑุฉ ุงูููู ุงูุทุจู</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="page-fade">
    <div class="bg-animation"></div>

    <div class="container">
        <header class="navbar">
            <a href="index.html" class="nav-brand">LifeBand</a>
            <div class="nav-links">
                <a href="index.html" class="nav-item">ุงูุฑุฆูุณูุฉ</a>
                <a href="tips.html" class="nav-item">ูุตุงุฆุญ ุทุจูุฉ</a>
                
                <div class="dropdown">
                    <button class="nav-item" style="background:none; border:none; cursor:pointer; font-family: inherit;">ูููุฎุชุตูู โผ</button>
                    <div class="dropdown-content">
                        <a href="volunteering.html">ุงูุชุทูุน ุงูุตุญู</a>    
                        <a href="innovation.html">ุงูุงุจุชูุงุฑ</a>
                        <a href="awareness.html">ุงูุชูุนูุฉ ูุงูุชุซููู</a>
                        <a href="media.html">ุงููุฑูุฒ ุงูุฅุนูุงูู</a>
                    </div>
                </div>

                <span id="auth-zone">
                    <a href="login.html" class="nav-item">ุฏุฎูู</a>
                    <a href="register.html" class="nav-item">ุฅูุดุงุก ุญุณุงุจ</a>
                </span>

                <button id="themeBtn" class="theme-toggle">๐</button>
            </div>
        </header>

        <main style="display: flex; justify-content: center; padding-top: 20px;">
            <div class="glass-card" style="width: 100%; max-width: 550px; z-index: 10;">
                <h2 style="color: var(--primary); margin-bottom: 25px; text-align: center;">ุฅุฏุงุฑุฉ ุงูููู ุงูุทุจู</h2>
                
                <div class="input-group">
                    <label>ุงูุงุณู ุงููุงูู:</label>
                    <input type="text" id="userName" class="input-style" placeholder="ุงุณูู ุงูุซูุงุซู">
                </div>

                <div class="input-group" style="margin-top: 15px;">
                    <label>ุฑูู ุงููููุฉ / ุงูุฅูุงูุฉ:</label>
                    <input type="text" id="userIdNo" class="input-style" placeholder="10XXXXXXXX">
                </div>

                <div class="input-group" style="margin-top: 15px;">
                    <label>ูุตููุฉ ุงูุฏู:</label>
                    <select id="userBlood" class="input-style">
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                    </select>
                </div>

                <div class="input-group" style="margin-top: 20px;">
                    <label>ุงูุฃูุฑุงุถ ุงููุฒููุฉ (ุงุฎุชุฑ ูุง ููุทุจู):</label>
                    <div id="diseasesList" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <label class="check-container">ุงูุณูุฑู <input type="checkbox" value="ุงูุณูุฑู"><span class="checkmark"></span></label>
                        <label class="check-container">ุงูุถุบุท <input type="checkbox" value="ุงูุถุบุท"><span class="checkmark"></span></label>
                        <label class="check-container">ุงูุฑุจู <input type="checkbox" value="ุงูุฑุจู"><span class="checkmark"></span></label>
                        <label class="check-container">ุฃูุฑุงุถ ุงูููุจ <input type="checkbox" value="ุฃูุฑุงุถ ุงูููุจ"><span class="checkmark"></span></label>
                        <label class="check-container">ุญุณุงุณูุฉ ุฏูุงุก <input type="checkbox" value="ุญุณุงุณูุฉ ุฏูุงุก"><span class="checkmark"></span></label>
                        <label class="check-container">ุงูุตุฑุน <input type="checkbox" value="ุงูุตุฑุน"><span class="checkmark"></span></label>
                    </div>
                </div>

                <div style="margin-top: 30px; display: flex; flex-direction: column; gap: 12px;">
                    <button id="saveBtn" class="main-btn">๐พ ุญูุธ ุงูุชุนุฏููุงุช</button>
                    <button id="shareEmergencyBtn" class="main-btn" style="background: var(--secondary);">๐ ูุณุฎ ุฑุงุจุท ุงูุทูุงุฑุฆ ุงูุฎุงุต ุจู</button>
                    <button id="exportBtn" class="main-btn" style="background: var(--glass); color: var(--text-main); border: 1px solid var(--glass-border);">๐ ุชุตุฏูุฑ ุงูุจูุงูุงุช ูููู ูุตู</button>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { auth, db } from './js/firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { ref, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const authZone = document.getElementById('auth-zone');
        const themeBtn = document.getElementById('themeBtn');

        // 1. ูุธุงู ุงูุซูู
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeBtn.innerText = 'โ๏ธ';
            } else {
                document.body.removeAttribute('data-theme');
                themeBtn.innerText = '๐';
            }
        }
        applyTheme(localStorage.getItem('theme') || 'light');

        themeBtn.onclick = () => {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const nt = isDark ? 'light' : 'dark';
            localStorage.setItem('theme', nt);
            applyTheme(nt);
        };

        // 2. ูุฑุงูุจุฉ ุญุงูุฉ ุงููุณุชุฎุฏู ูุชุญุฏูุซ ุงููุงุฆูุฉ + ุฌูุจ ุงูุจูุงูุงุช
     // 2. ุฌูุจ ุงูุจูุงูุงุช ุนูุฏ ุงูุชุญููู ูู ูุณุงุฑ users ุงูุฌุฏูุฏ
onAuthStateChanged(auth, async (user) => {
    if (user) {
        // ุชุญุฏูุซ ุงููุงุฆูุฉ ุงูุนูููุฉ ูุชุธูุฑ ุฃูู ูุณุฌู ุฏุฎูู
        const authZone = document.getElementById('auth-zone');
        if (authZone) {
            authZone.innerHTML = `
                <a href="profile.html?id=${user.uid}" class="nav-item active">ูููู ุงูุทุจู</a>
                <button id="logoutBtn" class="nav-item" style="background:none; border:none; cursor:pointer; font-family: inherit; color: #ef4444;">ุชุณุฌูู ุฎุฑูุฌ</button>
            `;
            document.getElementById('logoutBtn').onclick = () => {
                if(confirm("ูู ุชุฑูุฏ ุชุณุฌูู ุงูุฎุฑูุฌุ")) signOut(auth).then(() => window.location.href = "index.html");
            };
        }

        // ุฌูุจ ุงูุจูุงูุงุช ูู ูุณุงุฑ 'users' ุจุฏูุงู ูู 'patients'
        const snapshot = await get(ref(db, 'users/' + user.uid)); 
        if (snapshot.exists()) {
            const data = snapshot.val();
            // ุชุนุจุฆุฉ ุงูุญููู ุชููุงุฆูุงู ุจุงูุจูุงูุงุช ุงูุชู ุฃุฏุฎูุชูุง ูู ุงูุชุณุฌูู
            document.getElementById('userName').value = data.name || "";
            document.getElementById('userIdNo').value = data.idNo || "";
            document.getElementById('userBlood').value = data.bloodType || "A+";
            
            // ูู ุญุงู ูุฌูุฏ ุฃูุฑุงุถ ูุฒููุฉ ูุญููุธุฉ ูุณุจูุงู
            const savedDiseases = data.diseases || [];
            document.querySelectorAll('#diseasesList input').forEach(input => {
                if (savedDiseases.includes(input.value)) input.checked = true;
            });
        }
    } else {
        window.location.href = "login.html";
    }
});

// 3. ุชุญุฏูุซ ูุธููุฉ ุงูุญูุธ ูุชุณุชุฎุฏู ููุณ ุงููุณุงุฑ 'users'
document.getElementById('saveBtn').addEventListener('click', async () => {
    const user = auth.currentUser;
    if (user) {
        const selectedDiseases = Array.from(document.querySelectorAll('#diseasesList input:checked')).map(i => i.value);
        const newData = {
            name: document.getElementById('userName').value,
            idNo: document.getElementById('userIdNo').value,
            bloodType: document.getElementById('userBlood').value,
            diseases: selectedDiseases,
            role: "user" // ุงูุญูุงุธ ุนูู ููุน ุงูุญุณุงุจ
        };
        try {
            await set(ref(db, 'users/' + user.uid), newData);
            alert("ุชู ุชุญุฏูุซ ูููู ุจูุฌุงุญ! โ");
        } catch (err) { alert("ุฎุทุฃ ูู ุงูุญูุธ: " + err.message); }
    }
});

        // 4. ูุณุฎ ุฑุงุจุท ุงูุทูุงุฑุฆ
        document.getElementById('shareEmergencyBtn').addEventListener('click', () => {
            const user = auth.currentUser;
            if (user) {
                const emergencyUrl = `${window.location.origin}${window.location.pathname.replace('profile.html', 'emergency.html')}?id=${user.uid}`;
                navigator.clipboard.writeText(emergencyUrl).then(() => {
                    alert("โ ุชู ูุณุฎ ุฑุงุจุท ุงูุทูุงุฑุฆ ุงูุฎุงุต ุจู!");
                });
            }
        });

        // 5. ุชุตุฏูุฑ ุงูุจูุงูุงุช
        document.getElementById('exportBtn').onclick = () => {
            const name = document.getElementById('userName').value;
            const content = `LifeBand Medical Profile\nName: ${name}\nID: ${document.getElementById('userIdNo').value}\nBlood: ${document.getElementById('userBlood').value}`;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `LifeBand_${name}.txt`;
            a.click();
        };
    </script>
</body>
</html>