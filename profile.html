<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù„ÙÙƒ Ø§Ù„Ø·Ø¨ÙŠ - LifeBand</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="page-fade">
    <div class="container">
        <header class="navbar">
            <a href="index.html" class="nav-brand" style="text-decoration: none;">LifeBand</a>
            <div id="owner-tools" style="display: none;">
                <button id="showUrlBtn" class="nav-item" style="background: var(--glass); border: none; cursor: pointer; color: var(--accent);">ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙˆØ§Ø±</button>
            </div>
        </header>

        <main class="glass-card" style="max-width: 600px; margin: 0 auto;">
            <div id="loader" style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø¢Ù…Ù†Ø©...</div>
            
            <div id="profile-content" style="display: none;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 id="viewName" style="font-size: 24px;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
                    <span id="viewId" style="color: var(--accent); font-size: 14px;"></span>
                </div>

                <div class="input-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© / Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©</label>
                    <input type="text" id="idNo" class="input-style" readonly>
                </div>

                <div class="input-group">
                    <label>ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…</label>
                    <select id="blood" class="input-style" disabled>
                        <option value="A+">A+</option><option value="O+">O+</option>
                        <option value="B+">B+</option><option value="AB+">AB+</option>
                        <option value="A-">A-</option><option value="O-">O-</option>
                        <option value="B-">B-</option><option value="AB-">AB-</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ ÙˆØ§Ù„Ø­Ø³Ø§Ø³ÙŠØ©</label>
                    <div id="diseaseContainer" style="margin-bottom: 10px;"></div>
                    <div id="addArea" style="display: none; gap: 8px;">
                        <input type="text" id="diseaseInput" class="input-style" style="flex: 1;" placeholder="Ù…Ø«Ø§Ù„: Ø­Ø³Ø§Ø³ÙŠØ© Ù‚Ù…Ø­">
                        <button id="addBtn" class="main-btn" style="width: auto; padding: 10px 20px;">Ø¥Ø¶Ø§ÙØ©</button>
                    </div>
                </div>

                <div class="input-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</label>
                    <input type="tel" id="emergency" class="input-style" readonly>
                </div>

                <button id="saveBtn" class="main-btn" style="display: none; margin-top: 20px;">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª âœ…</button>
            </div>
        </main>
    </div>

    <div id="urlModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center;">
        <div class="glass-card" style="width: 90%; max-width: 400px; text-align: center;">
            <h3>Ø±Ø§Ø¨Ø· Ù…Ù„ÙÙƒ Ù„Ù„Ø³ÙˆØ§Ø±</h3>
            <p style="font-size: 13px; color: #94a3b8; margin: 15px 0;">Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ¨Ø±Ù…Ø¬Ù‡ ÙÙŠ Ø´Ø±ÙŠØ­Ø© NFC</p>
            <div id="copyArea" style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; word-break: break-all; margin-bottom: 20px; color: var(--accent); font-family: monospace;"></div>
            <button onclick="copyLink()" class="main-btn">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
            <button onclick="document.getElementById('urlModal').style.display='none'" class="nav-item" style="margin-top: 10px; border: none; background: none; cursor: pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script type="module">
        import { db, auth } from './js/firebase-config.js';
        import { ref, get, set, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const urlParams = new URLSearchParams(window.location.search);
        const pid = urlParams.get('id');
        let diseaseList = [];

        function renderDiseases(editable) {
            const container = document.getElementById('diseaseContainer');
            container.innerHTML = diseaseList.length === 0 ? '<p style="color:#64748b; font-size:13px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ù…Ø±Ø§Ø¶ Ù…Ø³Ø¬Ù„Ø©</p>' : '';
            diseaseList.forEach((d, i) => {
                const tag = document.createElement('div');
                tag.className = 'disease-tag';
                tag.innerHTML = `${d} ${editable ? `<span class="remove-btn" onclick="window.delD(${i})">Ã—</span>` : ''}`;
                container.appendChild(tag);
            });
        }

        window.delD = (i) => { diseaseList.splice(i, 1); renderDiseases(true); };

        if (pid) {
            get(child(ref(db), `patients/${pid}`)).then((snap) => {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('profile-content').style.display = 'block';
                if (snap.exists()) {
                    const d = snap.val();
                    document.getElementById('viewName').innerText = d.name;
                    document.getElementById('idNo').value = d.idNo || '';
                    document.getElementById('blood').value = d.bloodType || 'A+';
                    document.getElementById('emergency').value = d.emergency || '';
                    diseaseList = d.diseases || [];
                    renderDiseases(false);
                }
            });

            onAuthStateChanged(auth, (user) => {
                if (user && user.uid === pid) {
                    document.getElementById('owner-tools').style.display = 'block';
                    document.getElementById('saveBtn').style.display = 'block';
                    document.getElementById('addArea').style.display = 'flex';
                    document.querySelectorAll('.input-style').forEach(el => { el.removeAttribute('readonly'); el.removeAttribute('disabled'); });
                    renderDiseases(true);
                    
                    document.getElementById('showUrlBtn').onclick = () => {
                        document.getElementById('copyArea').innerText = window.location.href;
                        document.getElementById('urlModal').style.display = 'flex';
                    };
                }
            });
        }

        document.getElementById('addBtn').onclick = () => {
            const val = document.getElementById('diseaseInput').value.trim();
            if(val) { diseaseList.push(val); document.getElementById('diseaseInput').value=''; renderDiseases(true); }
        };

        document.getElementById('saveBtn').onclick = async () => {
            await set(ref(db, 'patients/' + pid), {
                name: document.getElementById('viewName').innerText,
                idNo: document.getElementById('idNo').value,
                bloodType: document.getElementById('blood').value,
                emergency: document.getElementById('emergency').value,
                diseases: diseaseList
            });
            alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ù„ÙÙƒ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        };

        window.copyLink = () => {
            navigator.clipboard.writeText(window.location.href);
            alert("ØªÙ… Ø§Ù„Ù†Ø³Ø®!");
        };
    </script>
</body>
</html>