<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeBand - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .lang-toggle {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
            transition: 0.3s;
            backdrop-filter: blur(5px);
            font-family: sans-serif;
        }
        .lang-toggle:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }
    </style>
</head>
<body class="page-fade">
    <div class="bg-animation"></div>

    <div class="container">
        <header class="navbar">
            <a href="index.html" class="nav-brand">LifeBand</a>
            <div class="nav-links">
                <a href="index.html" class="nav-item" data-i18n="nav_home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                <a href="tips.html" class="nav-item" data-i18n="nav_tips">Ù†ØµØ§Ø¦Ø­ Ø·Ø¨ÙŠØ©</a>
                
                <div class="dropdown">
                    <button class="nav-item" style="background:none; border:none; cursor:pointer; font-family: inherit;" data-i18n="nav_specialists">Ù„Ù„Ù…Ø®ØªØµÙŠÙ† â–¼</button>
                    <div class="dropdown-content">
                        <a href="volunteering.html" data-i18n="drop_volunteer">Ø§Ù„ØªØ·ÙˆØ¹ Ø§Ù„ØµØ­ÙŠ</a>    
                        <a href="innovation.html" data-i18n="drop_innovation">Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±</a>
                        <a href="awareness.html" data-i18n="drop_awareness">Ø§Ù„ØªÙˆØ¹ÙŠØ© ÙˆØ§Ù„ØªØ«Ù‚ÙŠÙ</a>
                        <a href="media.html" data-i18n="drop_media">Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù…ÙŠ</a>
                    </div>
                </div>

                <span id="auth-zone"></span>
                <button id="langBtn" class="lang-toggle">EN</button>
                <button id="themeBtn" class="theme-toggle">ğŸŒ™</button>
            </div>
        </header>

        <main style="display: flex; justify-content: center; padding-top: 20px;">
            <div class="glass-card" style="width: 100%; max-width: 550px; z-index: 10;">
                <h2 id="profileTitle" style="color: var(--primary); margin-bottom: 25px; text-align: center;" data-i18n="profile_title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ</h2>
                
                <div class="input-group">
                    <label data-i18n="label_full_name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
                    <input type="text" id="userName" class="input-style" placeholder="...">
                </div>

                <div class="input-group" style="margin-top: 15px;">
                    <label data-i18n="label_id">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© / Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©:</label>
                    <input type="text" id="userIdNo" class="input-style" placeholder="10XXXXXXXX">
                </div>

                <div class="input-group" style="margin-top: 15px;">
                    <label data-i18n="label_blood">ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…:</label>
                    <select id="userBlood" class="input-style">
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                    </select>
                </div>

                <div class="input-group" style="margin-top: 20px;">
                    <label data-i18n="label_chronic">Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø© (Ø§Ø®ØªØ± Ù…Ø§ ÙŠÙ†Ø·Ø¨Ù‚):</label>
                    <div id="diseasesList" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <label class="check-container"><span data-i18n="dis_diabetes">Ø§Ù„Ø³ÙƒØ±ÙŠ</span> <input type="checkbox" value="Ø§Ù„Ø³ÙƒØ±ÙŠ"><span class="checkmark"></span></label>
                        <label class="check-container"><span data-i18n="dis_pressure">Ø§Ù„Ø¶ØºØ·</span> <input type="checkbox" value="Ø§Ù„Ø¶ØºØ·"><span class="checkmark"></span></label>
                        <label class="check-container"><span data-i18n="dis_asthma">Ø§Ù„Ø±Ø¨Ùˆ</span> <input type="checkbox" value="Ø§Ù„Ø±Ø¨Ùˆ"><span class="checkmark"></span></label>
                        <label class="check-container"><span data-i18n="dis_heart">Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù‚Ù„Ø¨</span> <input type="checkbox" value="Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù‚Ù„Ø¨"><span class="checkmark"></span></label>
                        <label class="check-container"><span data-i18n="dis_allergy">Ø­Ø³Ø§Ø³ÙŠØ© Ø¯ÙˆØ§Ø¡</span> <input type="checkbox" value="Ø­Ø³Ø§Ø³ÙŠØ© Ø¯ÙˆØ§Ø¡"><span class="checkmark"></span></label>
                        <label class="check-container"><span data-i18n="dis_epilepsy">Ø§Ù„ØµØ±Ø¹</span> <input type="checkbox" value="Ø§Ù„ØµØ±Ø¹"><span class="checkmark"></span></label>
                    </div>
                </div>

                <div style="margin-top: 30px; display: flex; flex-direction: column; gap: 12px;">
                    <button id="saveBtn" class="main-btn" data-i18n="btn_save">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                    <button id="shareEmergencyBtn" class="main-btn" style="background: var(--secondary);" data-i18n="btn_share">ğŸ”— Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ</button>
                    <button id="exportBtn" class="main-btn" style="background: var(--glass); color: var(--text-main); border: 1px solid var(--glass-border);" data-i18n="btn_export">ğŸ“„ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ…Ù„Ù Ù†ØµÙŠ</button>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { auth, db } from './js/firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { ref, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- 1. Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±Ø¬Ù…Ø© ---
        const translations = {
            ar: {
                nav_home: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
                nav_tips: "Ù†ØµØ§Ø¦Ø­ Ø·Ø¨ÙŠØ©",
                nav_specialists: "Ù„Ù„Ù…Ø®ØªØµÙŠÙ† â–¼",
                drop_volunteer: "Ø§Ù„ØªØ·ÙˆØ¹ Ø§Ù„ØµØ­ÙŠ",
                drop_innovation: "Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±",
                drop_awareness: "Ø§Ù„ØªÙˆØ¹ÙŠØ© ÙˆØ§Ù„ØªØ«Ù‚ÙŠÙ",
                drop_media: "Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù…ÙŠ",
                profile_title: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ",
                label_full_name: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:",
                label_id: "Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© / Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©:",
                label_blood: "ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…:",
                label_chronic: "Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø© (Ø§Ø®ØªØ± Ù…Ø§ ÙŠÙ†Ø·Ø¨Ù‚):",
                dis_diabetes: "Ø§Ù„Ø³ÙƒØ±ÙŠ",
                dis_pressure: "Ø§Ù„Ø¶ØºØ·",
                dis_asthma: "Ø§Ù„Ø±Ø¨Ùˆ",
                dis_heart: "Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù‚Ù„Ø¨",
                dis_allergy: "Ø­Ø³Ø§Ø³ÙŠØ© Ø¯ÙˆØ§Ø¡",
                dis_epilepsy: "Ø§Ù„ØµØ±Ø¹",
                btn_save: "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª",
                btn_share: "ğŸ”— Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø·ÙˆØ§Ø±Ø¦",
                btn_export: "ğŸ“„ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
                lang_label: "EN"
            },
            en: {
                nav_home: "Home",
                nav_tips: "Medical Tips",
                nav_specialists: "Specialists â–¼",
                drop_volunteer: "Volunteering",
                drop_innovation: "Innovation",
                drop_awareness: "Awareness",
                drop_media: "Media Center",
                profile_title: "Medical Profile Management",
                label_full_name: "Full Name:",
                label_id: "ID / Residency Number:",
                label_blood: "Blood Type:",
                label_chronic: "Chronic Diseases (Check all that apply):",
                dis_diabetes: "Diabetes",
                dis_pressure: "Hypertension",
                dis_asthma: "Asthma",
                dis_heart: "Heart Disease",
                dis_allergy: "Drug Allergy",
                dis_epilepsy: "Epilepsy",
                btn_save: "ğŸ’¾ Save Changes",
                btn_share: "ğŸ”— Copy Emergency Link",
                btn_export: "ğŸ“„ Export Data",
                lang_label: "AR"
            }
        };

        const langBtn = document.getElementById('langBtn');

        function setLanguage(lang) {
            const t = translations[lang];
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.innerText = t[key];
            });

            langBtn.innerText = t.lang_label;
            localStorage.setItem('preferred_lang', lang);
            updateAuthZoneUI(auth.currentUser);
        }

        langBtn.onclick = () => {
            const current = localStorage.getItem('preferred_lang') || 'ar';
            setLanguage(current === 'ar' ? 'en' : 'ar');
        };

        // --- 2. Ù†Ø¸Ø§Ù… Ø§Ù„Ø«ÙŠÙ… ---
        const themeBtn = document.getElementById('themeBtn');
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeBtn.innerText = 'â˜€ï¸';
            } else {
                document.body.removeAttribute('data-theme');
                themeBtn.innerText = 'ğŸŒ™';
            }
        }
        applyTheme(localStorage.getItem('theme') || 'light');
        themeBtn.onclick = () => {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const nt = isDark ? 'light' : 'dark';
            localStorage.setItem('theme', nt);
            applyTheme(nt);
        };

        // --- 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        function updateAuthZoneUI(user) {
            const lang = localStorage.getItem('preferred_lang') || 'ar';
            const authZone = document.getElementById('auth-zone');
            if (user) {
                authZone.innerHTML = `
                    <a href="profile.html?id=${user.uid}" class="nav-item active">${lang === 'ar' ? 'Ù…Ù„ÙÙŠ Ø§Ù„Ø·Ø¨ÙŠ' : 'My Profile'}</a>
                    <button id="logoutBtn" class="nav-item" style="background:none; border:none; cursor:pointer; font-family: inherit; color: #ef4444;">${lang === 'ar' ? 'ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬' : 'Logout'}</button>
                `;
                document.getElementById('logoutBtn').onclick = () => {
                    if(confirm(lang === 'ar' ? "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ" : "Logout?")) signOut(auth).then(() => window.location.href = "index.html");
                };
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                updateAuthZoneUI(user);
                const snapshot = await get(ref(db, 'users/' + user.uid)); 
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('userName').value = data.name || "";
                    document.getElementById('userIdNo').value = data.idNo || "";
                    document.getElementById('userBlood').value = data.bloodType || "A+";
                    const savedDiseases = data.diseases || [];
                    document.querySelectorAll('#diseasesList input').forEach(input => {
                        if (savedDiseases.includes(input.value)) input.checked = true;
                    });
                }
            } else {
                window.location.href = "login.html";
            }
        });

        document.getElementById('saveBtn').addEventListener('click', async () => {
            const user = auth.currentUser;
            const lang = localStorage.getItem('preferred_lang') || 'ar';
            if (user) {
                const selectedDiseases = Array.from(document.querySelectorAll('#diseasesList input:checked')).map(i => i.value);
                const newData = {
                    name: document.getElementById('userName').value,
                    idNo: document.getElementById('userIdNo').value,
                    bloodType: document.getElementById('userBlood').value,
                    diseases: selectedDiseases,
                    role: "user"
                };
                try {
                    await set(ref(db, 'users/' + user.uid), newData);
                    alert(lang === 'ar' ? "ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­! âœ…" : "Updated successfully! âœ…");
                } catch (err) { alert(err.message); }
            }
        });

        document.getElementById('shareEmergencyBtn').addEventListener('click', () => {
            const user = auth.currentUser;
            const lang = localStorage.getItem('preferred_lang') || 'ar';
            if (user) {
                const emergencyUrl = `${window.location.origin}${window.location.pathname.replace('profile.html', 'emergency.html')}?id=${user.uid}`;
                navigator.clipboard.writeText(emergencyUrl).then(() => {
                    alert(lang === 'ar' ? "âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!" : "âœ… Link copied!");
                });
            }
        });

        document.getElementById('exportBtn').onclick = () => {
            const name = document.getElementById('userName').value;
            const content = `LifeBand Medical Profile\nName: ${name}\nID: ${document.getElementById('userIdNo').value}\nBlood: ${document.getElementById('userBlood').value}`;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `LifeBand_${name}.txt`;
            a.click();
        };

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„ØºØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        setLanguage(localStorage.getItem('preferred_lang') || 'ar');
    </script>
</body>
</html>