<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ - LifeBand</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="page-fade">
    <div class="container">
        <header class="navbar">
            <a href="index.html" class="nav-brand">LifeBand</a>
            <div id="owner-tools" style="display: none;">
                <button id="showUrlBtn" class="nav-item" style="background: var(--glass); border: none; cursor: pointer; color: var(--accent); font-weight: bold;">ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙˆØ§Ø±</button>
            </div>
        </header>

        <main class="glass-card" style="max-width: 650px; margin: 0 auto;">
            <div id="loader" style="text-align: center; padding: 40px;">
                <div style="border: 4px solid var(--glass); border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <p>Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø¢Ù…Ù†Ø©...</p>
            </div>
            
            <div id="profile-content" style="display: none;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 id="viewName" style="font-size: 28px; color: var(--accent);">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
                    <p style="color: #64748b; font-size: 13px; margin-top: 5px;">Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ù‚Ù…ÙŠ: <span id="userIdDisplay"></span></p>
                </div>

                <div class="input-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© / Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©</label>
                    <input type="text" id="idNo" class="input-style" readonly placeholder="Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„">
                </div>

                <div class="input-group">
                    <label>ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…</label>
                    <select id="blood" class="input-style" disabled>
                        <option value="ØºÙŠØ± Ù…Ø­Ø¯Ø¯">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙŠÙ„Ø©</option>
                        <option value="A+">A+</option><option value="O+">O+</option><option value="B+">B+</option><option value="AB+">AB+</option>
                        <option value="A-">A-</option><option value="O-">O-</option><option value="B-">B-</option><option value="AB-">AB-</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ ÙˆØ§Ù„Ø­Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ù…Ø³Ø¬Ù„Ø©)</label>
                    <div id="diseaseContainer" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; min-height: 60px; margin-bottom: 10px;"></div>
                    <div id="addArea" style="display: none; gap: 10px;">
                        <input type="text" id="diseaseInput" class="input-style" style="flex: 1;" placeholder="Ø£Ø¶Ù Ù…Ø±Ø¶ Ø£Ùˆ Ø­Ø³Ø§Ø³ÙŠØ©...">
                        <button id="addBtn" class="main-btn" style="width: auto; padding: 10px 20px;">Ø¥Ø¶Ø§ÙØ©</button>
                    </div>
                </div>

                <div class="input-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ù„Ù„ØªÙˆØ§ØµÙ„</label>
                    <input type="tel" id="emergency" class="input-style" readonly placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø´Ø®Øµ Ù‚Ø±ÙŠØ¨">
                </div>

                <button id="saveBtn" class="main-btn" style="display: none; margin-top: 30px;">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ø§Ù„Ù…Ù„Ù âœ…</button>
            </div>
        </main>
    </div>

    <div id="urlModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center;">
        <div class="glass-card" style="width: 90%; max-width: 450px; text-align: center;">
            <h3 style="color: var(--accent);">Ø±Ø§Ø¨Ø· Ø³ÙˆØ§Ø± LifeBand</h3>
            <p style="font-size: 14px; color: #94a3b8; margin: 15px 0;">Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆÙ‚Ù… Ø¨Ø¨Ø±Ù…Ø¬ØªÙ‡ Ø¯Ø§Ø®Ù„ Ø´Ø±ÙŠØ­Ø© NFC Ø§Ù„Ø³ÙˆØ§Ø± Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ.</p>
            <div id="copyArea" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; word-break: break-all; margin-bottom: 25px; color: white; border: 1px dashed var(--accent); font-family: monospace;"></div>
            <button onclick="copyLink()" class="main-btn">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¢Ù†</button>
            <button onclick="document.getElementById('urlModal').style.display='none'" style="margin-top: 15px; background: none; border: none; color: #ef4444; cursor: pointer;">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©</button>
        </div>
    </div>

    <style> @keyframes spin { 100% { transform: rotate(360deg); } } </style>

    <script type="module">
        import { db, auth } from './js/firebase-config.js';
        import { ref, get, set, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const urlParams = new URLSearchParams(window.location.search);
        const pid = urlParams.get('id');
        let diseaseList = [];

        function renderDiseases(editable) {
            const container = document.getElementById('diseaseContainer');
            container.innerHTML = diseaseList.length === 0 ? '<p style="color:#64748b; font-size:13px; text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>' : '';
            diseaseList.forEach((d, i) => {
                const tag = document.createElement('div');
                tag.className = 'disease-tag';
                tag.innerHTML = `<span>${d}</span> ${editable ? `<span class="remove-btn" onclick="window.delD(${i})">Ã—</span>` : ''}`;
                container.appendChild(tag);
            });
        }

        window.delD = (i) => { diseaseList.splice(i, 1); renderDiseases(true); };

        if (pid) {
            document.getElementById('userIdDisplay').innerText = pid.substring(0, 8) + "...";
            get(child(ref(db), `patients/${pid}`)).then((snap) => {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('profile-content').style.display = 'block';
                if (snap.exists()) {
                    const d = snap.val();
                    document.getElementById('viewName').innerText = d.name;
                    document.getElementById('idNo').value = d.idNo || '';
                    document.getElementById('blood').value = d.bloodType || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    document.getElementById('emergency').value = d.emergency || '';
                    diseaseList = d.diseases || [];
                    renderDiseases(false);
                }
            });

            onAuthStateChanged(auth, (user) => {
                if (user && user.uid === pid) {
                    document.getElementById('owner-tools').style.display = 'block';
                    document.getElementById('saveBtn').style.display = 'block';
                    document.getElementById('addArea').style.display = 'flex';
                    document.querySelectorAll('.input-style').forEach(el => { el.removeAttribute('readonly'); el.removeAttribute('disabled'); });
                    renderDiseases(true);
                    
                    document.getElementById('showUrlBtn').onclick = () => {
                        document.getElementById('copyArea').innerText = window.location.href;
                        document.getElementById('urlModal').style.display = 'flex';
                    };
                }
            });
        }

        document.getElementById('addBtn').onclick = () => {
            const val = document.getElementById('diseaseInput').value.trim();
            if(val) { diseaseList.push(val); document.getElementById('diseaseInput').value=''; renderDiseases(true); }
        };

        document.getElementById('saveBtn').onclick = async () => {
            await set(ref(db, 'patients/' + pid), {
                name: document.getElementById('viewName').innerText,
                idNo: document.getElementById('idNo').value,
                bloodType: document.getElementById('blood').value,
                emergency: document.getElementById('emergency').value,
                diseases: diseaseList
            });
            alert("ØªÙ… Ø­ÙØ¸ Ù…Ù„ÙÙƒ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø±Ø§Ø¨Ø· Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø¢Ù† âœ…");
        };

        window.copyLink = () => {
            navigator.clipboard.writeText(window.location.href);
            alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·! ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚Ù‡ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø³ÙˆØ§Ø±.");
        };
    </script>
</body>
</html>