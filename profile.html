<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ - LifeBand</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="page-fade">
    <div class="bg-animation"></div>

    <div class="container">
        <header class="navbar">
            <a href="index.html" class="nav-brand">LifeBand</a>
            <div class="nav-links">
                <a href="index.html" class="nav-item">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                <a href="tips.html" class="nav-item">Ù†ØµØ§Ø¦Ø­ Ø·Ø¨ÙŠØ©</a>
                <button id="themeBtn" class="theme-toggle">ğŸŒ™</button>
            </div>
        </header>

        <main style="display: flex; justify-content: center; padding-top: 20px;">
            <div class="glass-card" style="width: 100%; max-width: 550px;">
                <h2 style="color: var(--primary); margin-bottom: 25px; text-align: center;">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</h2>
                
                <div class="input-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
                    <input type="text" id="userName" class="input-style" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ">
                </div>

                <div class="input-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© / Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©:</label>
                    <input type="text" id="userIdNo" class="input-style" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©">
                </div>

                <div class="input-group">
                    <label>ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…:</label>
                    <select id="userBlood" class="input-style">
                        <option value="A+">A+</option><option value="A-">A-</option>
                        <option value="B+">B+</option><option value="B-">B-</option>
                        <option value="O+">O+</option><option value="O-">O-</option>
                        <option value="AB+">AB+</option><option value="AB-">AB-</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ ÙˆØ§Ù„Ø­Ø³Ø§Ø³ÙŠØ©:</label>
                    <div id="diseasesList" style="margin-bottom: 10px; min-height: 40px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px;">
                        </div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="diseaseInput" class="input-style" style="margin:0" placeholder="Ø£Ø¶Ù Ù…Ø±Ø¶ Ø£Ùˆ Ø­Ø³Ø§Ø³ÙŠØ©...">
                        <button type="button" id="addDiseaseBtn" class="main-btn" style="width: auto; padding: 10px 20px;">Ø¥Ø¶Ø§ÙØ©</button>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button id="saveBtn" class="main-btn">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                    <button id="exportBtn" class="main-btn" style="background: var(--accent);">Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { db, auth } from './js/firebase-config.js';
        import { ref, get, set, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        let diseases = [];

        // --- 1. Ù†Ø¸Ø§Ù… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯ Ø§Ù„Ù…ÙˆØ­Ø¯ ---
        const themeBtn = document.getElementById('themeBtn');
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeBtn.innerText = 'â˜€ï¸';
            } else {
                document.body.removeAttribute('data-theme');
                themeBtn.innerText = 'ğŸŒ™';
            }
        }
        applyTheme(localStorage.getItem('theme') || 'light');
        themeBtn.onclick = () => {
            const newTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        };

        // --- 2. Ø¥Ø¯Ø§Ø±Ø© Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ ---
        function renderDiseases() {
            const list = document.getElementById('diseasesList');
            list.innerHTML = diseases.length === 0 ? '<p style="color:gray; font-size:13px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù…Ø±Ø§Ø¶ Ù…Ø³Ø¬Ù„Ø©</p>' : '';
            diseases.forEach((d, index) => {
                const tag = document.createElement('div');
                tag.className = 'disease-tag';
                tag.innerHTML = `<span>${d}</span> <span class="remove-btn" onclick="window.delDisease(${index})">Ã—</span>`;
                list.appendChild(tag);
            });
        }

        window.delDisease = (index) => {
            diseases.splice(index, 1);
            renderDiseases();
        };

        document.getElementById('addDiseaseBtn').onclick = () => {
            const val = document.getElementById('diseaseInput').value.trim();
            if (val) {
                diseases.push(val);
                document.getElementById('diseaseInput').value = '';
                renderDiseases();
            }
        };

        // --- 3. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                get(child(ref(db), `patients/${user.uid}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        document.getElementById('userName').value = data.name || "";
                        document.getElementById('userIdNo').value = data.idNo || "";
                        document.getElementById('userBlood').value = data.bloodType || "O+";
                        diseases = data.diseases || [];
                        renderDiseases();
                    }
                });
            } else {
                window.location.href = "login.html";
            }
        });

        // --- 4. Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        document.getElementById('saveBtn').onclick = async () => {
            const user = auth.currentUser;
            if (user) {
                const newData = {
                    name: document.getElementById('userName').value,
                    idNo: document.getElementById('userIdNo').value,
                    bloodType: document.getElementById('userBlood').value,
                    diseases: diseases
                };
                try {
                    await set(ref(db, 'patients/' + user.uid), newData);
                    alert("ØªÙ… Ø­ÙØ¸ Ù…Ù„ÙÙƒ Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ù†Ø¬Ø§Ø­! âœ…");
                } catch (err) { alert("Ø®Ø·Ø£: " + err.message); }
            }
        };

        // --- 5. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        document.getElementById('exportBtn').onclick = () => {
            const name = document.getElementById('userName').value;
            const content = `Ù…Ù„Ù LifeBand Ø§Ù„Ø·Ø¨ÙŠ\n----------------\nØ§Ù„Ø§Ø³Ù…: ${name}\nØ±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©: ${document.getElementById('userIdNo').value}\nØ§Ù„ÙØµÙŠÙ„Ø©: ${document.getElementById('userBlood').value}\nØ§Ù„Ø£Ù…Ø±Ø§Ø¶: ${diseases.join(', ')}`;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `LifeBand_Profile_${name}.txt`;
            a.click();
        };
    </script>
</body>
</html>