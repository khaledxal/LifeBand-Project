<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูููู ุงูุทุจู ุงูุดุฎุตู - LifeBand</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="page-fade">
    <div class="bg-animation"></div>

    <div class="container">
        <header class="navbar">
            <a href="index.html" class="nav-brand">LifeBand</a>
            <div class="nav-links">
                <a href="index.html" class="nav-item">ุงูุฑุฆูุณูุฉ</a>
                <a href="tips.html" class="nav-item">ูุตุงุฆุญ ุทุจูุฉ</a>
                <button id="themeBtn" class="theme-toggle">๐</button>
            </div>
        </header>

        <main style="display: flex; justify-content: center; padding-top: 20px;">
            <div class="glass-card" style="width: 100%; max-width: 550px;">
                <h2 style="color: var(--primary); margin-bottom: 25px; text-align: center;">ุฅุฏุงุฑุฉ ุงูููู ุงูุทุจู</h2>
                
                <div class="input-group">
                    <label>ุงูุงุณู ุงููุงูู:</label>
                    <input type="text" id="userName" class="input-style" placeholder="ุงุณูู ุงูุซูุงุซู">
                </div>

                <div class="input-group" style="margin-top: 15px;">
                    <label>ุฑูู ุงููููุฉ / ุงูุฅูุงูุฉ:</label>
                    <input type="text" id="userIdNo" class="input-style" placeholder="10XXXXXXXX">
                </div>

                <div class="input-group" style="margin-top: 15px;">
                    <label>ูุตููุฉ ุงูุฏู:</label>
                    <select id="userBlood" class="input-style">
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                    </select>
                </div>

                <div class="input-group" style="margin-top: 20px;">
                    <label>ุงูุฃูุฑุงุถ ุงููุฒููุฉ (ุงุฎุชุฑ ูุง ููุทุจู):</label>
                    <div id="diseasesList" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <label class="check-container">ุงูุณูุฑู <input type="checkbox" value="ุงูุณูุฑู"><span class="checkmark"></span></label>
                        <label class="check-container">ุงูุถุบุท <input type="checkbox" value="ุงูุถุบุท"><span class="checkmark"></span></label>
                        <label class="check-container">ุงูุฑุจู <input type="checkbox" value="ุงูุฑุจู"><span class="checkmark"></span></label>
                        <label class="check-container">ุฃูุฑุงุถ ุงูููุจ <input type="checkbox" value="ุฃูุฑุงุถ ุงูููุจ"><span class="checkmark"></span></label>
                        <label class="check-container">ุญุณุงุณูุฉ ุฏูุงุก <input type="checkbox" value="ุญุณุงุณูุฉ ุฏูุงุก"><span class="checkmark"></span></label>
                        <label class="check-container">ุงูุตุฑุน <input type="checkbox" value="ุงูุตุฑุน"><span class="checkmark"></span></label>
                    </div>
                </div>

                <div style="margin-top: 30px; display: flex; flex-direction: column; gap: 10px;">
                    <button id="saveBtn" class="main-btn">๐พ ุญูุธ ุงูุชุนุฏููุงุช</button>
                    <button id="shareEmergencyBtn" class="main-btn" style="background: var(--secondary);">๐ ูุณุฎ ุฑุงุจุท ุงูุทูุงุฑุฆ ุงูุฎุงุต ุจู</button>
                    <button id="exportBtn" class="main-btn" style="background: var(--glass); color: var(--text-main); border: 1px solid var(--glass-border);">๐ ุชุตุฏูุฑ ุงูุจูุงูุงุช ูููู ูุตู</button>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { ref, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- 1. ุซูู ุงูุตูุญุฉ ---
        const themeBtn = document.getElementById('themeBtn');
        themeBtn.onclick = () => {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? '' : 'dark');
            themeBtn.innerText = isDark ? '๐' : 'โ๏ธ';
        };

        // --- 2. ุฌูุจ ุงูุจูุงูุงุช ุนูุฏ ุงูุฏุฎูู ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snapshot = await get(ref(db, 'patients/' + user.uid));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('userName').value = data.name || "";
                    document.getElementById('userIdNo').value = data.idNo || "";
                    document.getElementById('userBlood').value = data.bloodType || "A+";
                    
                    // ุชุญุฏูุฏ ุงูุฃูุฑุงุถ ุงููุฎุชุงุฑุฉ
                    const savedDiseases = data.diseases || [];
                    document.querySelectorAll('#diseasesList input').forEach(input => {
                        if (savedDiseases.includes(input.value)) input.checked = true;
                    });
                }
            } else {
                window.location.href = "login.html";
            }
        });

        // --- 3. ุญูุธ ุงูุจูุงูุงุช ---
        document.getElementById('saveBtn').onclick = async () => {
            const user = auth.currentUser;
            if (user) {
                const selectedDiseases = Array.from(document.querySelectorAll('#diseasesList input:checked')).map(i => i.value);
                const newData = {
                    name: document.getElementById('userName').value,
                    idNo: document.getElementById('userIdNo').value,
                    bloodType: document.getElementById('userBlood').value,
                    diseases: selectedDiseases
                };
                try {
                    await set(ref(db, 'patients/' + user.uid), newData);
                    alert("ุชู ุชุญุฏูุซ ูููู ุงูุทุจู ุจูุฌุงุญ! โ");
                } catch (err) { alert("ุฎุทุฃ ูู ุงูุญูุธ: " + err.message); }
            }
        };

        // --- 4. ุงุณุชุฎุฑุงุฌ ุฑุงุจุท ุงูุทูุงุฑุฆ ---
        document.getElementById('shareEmergencyBtn').onclick = () => {
            const user = auth.currentUser;
            if (user) {
                // ููุงุญุธุฉ: ุงุณุชุจุฏู ุฑุงุจุท ุงูุงุณุชุถุงูุฉ ุฅุฐุง ููุช ุจุฑูุน ุงููุดุฑูุน
                const emergencyUrl = `${window.location.origin}/emergency.html?id=${user.uid}`;
                navigator.clipboard.writeText(emergencyUrl).then(() => {
                    alert("โ ุชู ูุณุฎ ุฑุงุจุท ุงูุทูุงุฑุฆ!\n\nูููู ูููุณุนู ูุณุญ ูุฐุง ุงูุฑุงุจุท (ุนุจุฑ ููุฏ QR) ูููุตูู ููุนูููุงุชู ูู ุงูุญุงูุงุช ุงูุญุฑุฌุฉ.");
                });
            }
        };

        // --- 5. ุชุตุฏูุฑ ูููู ูุตู ---
        document.getElementById('exportBtn').onclick = () => {
            const name = document.getElementById('userName').value;
            const selectedDiseases = Array.from(document.querySelectorAll('#diseasesList input:checked')).map(i => i.value);
            const content = `LifeBand - ุงูููู ุงูุทุจู\nุงูุงุณู: ${name}\nุฑูู ุงููููุฉ: ${document.getElementById('userIdNo').value}\nุงููุตููุฉ: ${document.getElementById('userBlood').value}\nุงูุฃูุฑุงุถ: ${selectedDiseases.join(', ')}`;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `LifeBand_${name}.txt`;
            a.click();
        };
    </script>
</body>
</html>