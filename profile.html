<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeBand - ุฅุฏุงุฑุฉ ุงูููู ุงูุทุจู</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="page-fade">
    <div class="bg-animation"></div>

    <div class="container" id="main-layout">
        
        <main style="display: flex; justify-content: center; padding-top: 20px;">
            <div class="glass-card" style="width: 100%; max-width: 550px; z-index: 10;">
                <h2 id="profileTitle" style="color: var(--primary); margin-bottom: 25px; text-align: center;" data-i18n="profile_title">ุฅุฏุงุฑุฉ ุงูููู ุงูุทุจู</h2>
                
                <div class="input-group">
                    <label data-i18n="label_full_name">ุงูุงุณู ุงููุงูู:</label>
                    <input type="text" id="userName" class="input-style" placeholder="...">
                </div>

                <div class="input-group" style="margin-top: 15px;">
                    <label data-i18n="label_id">ุฑูู ุงููููุฉ / ุงูุฅูุงูุฉ:</label>
                    <input type="text" id="userIdNo" class="input-style" placeholder="10XXXXXXXX">
                </div>

                <div class="input-group" style="margin-top: 15px;">
                    <label data-i18n="label_blood">ูุตููุฉ ุงูุฏู:</label>
                    <select id="userBlood" class="input-style">
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                    </select>
                </div>

                <div class="input-group" style="margin-top: 20px;">
                    <label data-i18n="label_chronic">ุงูุฃูุฑุงุถ ุงููุฒููุฉ (ุงุฎุชุฑ ูุง ููุทุจู):</label>
                    <div id="diseasesList" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <label class="check-container"><span data-i18n="dis_diabetes">ุงูุณูุฑู</span> <input type="checkbox" value="ุงูุณูุฑู"><span class="checkmark"></span></label>
                        <label class="check-container"><span data-i18n="dis_pressure">ุงูุถุบุท</span> <input type="checkbox" value="ุงูุถุบุท"><span class="checkmark"></span></label>
                        <label class="check-container"><span data-i18n="dis_asthma">ุงูุฑุจู</span> <input type="checkbox" value="ุงูุฑุจู"><span class="checkmark"></span></label>
                        <label class="check-container"><span data-i18n="dis_heart">ุฃูุฑุงุถ ุงูููุจ</span> <input type="checkbox" value="ุฃูุฑุงุถ ุงูููุจ"><span class="checkmark"></span></label>
                        <label class="check-container"><span data-i18n="dis_allergy">ุญุณุงุณูุฉ ุฏูุงุก</span> <input type="checkbox" value="ุญุณุงุณูุฉ ุฏูุงุก"><span class="checkmark"></span></label>
                        <label class="check-container"><span data-i18n="dis_epilepsy">ุงูุตุฑุน</span> <input type="checkbox" value="ุงูุตุฑุน"><span class="checkmark"></span></label>
                    </div>
                </div>

                <div style="margin-top: 30px; display: flex; flex-direction: column; gap: 12px;">
                    <button id="saveBtn" class="main-btn" data-i18n="btn_save">๐พ ุญูุธ ุงูุชุนุฏููุงุช</button>
                    <button id="shareEmergencyBtn" class="main-btn" style="background: var(--secondary);" data-i18n="btn_share">๐ ูุณุฎ ุฑุงุจุท ุงูุทูุงุฑุฆ ุงูุฎุงุต ุจู</button>
                    <button id="exportBtn" class="main-btn" style="background: var(--glass); color: var(--text-main); border: 1px solid var(--glass-border);" data-i18n="btn_export">๐ ุชุตุฏูุฑ ุงูุจูุงูุงุช ูููู ูุตู</button>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { injectLayout } from './js/layout.js';
        import { auth, db } from './js/firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { ref, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // 1. ุชุดุบูู ุงููููู ุงูููุญุฏ (ุงูููุฏุฑ ูุงูููุชุฑ)
        injectLayout();

        // 2. ุฅุฏุงุฑุฉ ุญุงูุฉ ุงููุณุชุฎุฏู ูุฌูุจ ุงูุจูุงูุงุช
        onAuthStateChanged(auth, async (user) => {
            const lang = localStorage.getItem('preferred_lang') || 'ar';
            const authZone = document.getElementById('auth-zone');

            if (user) {
                // ุชุญุฏูุซ ููุทูุฉ ุงูุฏุฎูู ูู ุงููุงู ุจุงุฑ ูุฏููุงู ุฅุฐุง ูุฒู ุงูุฃูุฑ
                if(authZone) {
                    authZone.innerHTML = `
                        <a href="profile.html?id=${user.uid}" class="nav-item active">${lang === 'ar' ? 'ูููู' : 'Profile'}</a>
                        <button id="logoutBtn" class="nav-item" style="background:none; border:none; cursor:pointer; color: #ef4444;">${lang === 'ar' ? 'ุฎุฑูุฌ' : 'Logout'}</button>
                    `;
                    document.getElementById('logoutBtn').onclick = () => {
                        if(confirm(lang === 'ar' ? "ุชุณุฌูู ุงูุฎุฑูุฌุ" : "Logout?")) signOut(auth).then(() => window.location.href = "index.html");
                    };
                }

                // ุฌูุจ ุจูุงูุงุช ุงูููู ุงูุทุจู ูู Firebase
                const snapshot = await get(ref(db, 'users/' + user.uid)); 
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('userName').value = data.name || "";
                    document.getElementById('userIdNo').value = data.idNo || "";
                    document.getElementById('userBlood').value = data.bloodType || "A+";
                    const savedDiseases = data.diseases || [];
                    document.querySelectorAll('#diseasesList input').forEach(input => {
                        if (savedDiseases.includes(input.value)) input.checked = true;
                    });
                }
            } else {
                window.location.href = "login.html";
            }
        });

        // 3. ุญูุธ ุงูุชุนุฏููุงุช
        document.getElementById('saveBtn').addEventListener('click', async () => {
            const user = auth.currentUser;
            const lang = localStorage.getItem('preferred_lang') || 'ar';
            if (user) {
                const selectedDiseases = Array.from(document.querySelectorAll('#diseasesList input:checked')).map(i => i.value);
                const newData = {
                    name: document.getElementById('userName').value,
                    idNo: document.getElementById('userIdNo').value,
                    bloodType: document.getElementById('userBlood').value,
                    diseases: selectedDiseases,
                    role: "user"
                };
                try {
                    await set(ref(db, 'users/' + user.uid), newData);
                    alert(lang === 'ar' ? "ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ! โ" : "Updated successfully! โ");
                } catch (err) { alert(err.message); }
            }
        });

        // 4. ูุณุฎ ุฑุงุจุท ุงูุทูุงุฑุฆ
        document.getElementById('shareEmergencyBtn').addEventListener('click', () => {
            const user = auth.currentUser;
            const lang = localStorage.getItem('preferred_lang') || 'ar';
            if (user) {
                const emergencyUrl = `${window.location.origin}${window.location.pathname.replace('profile.html', 'emergency.html')}?id=${user.uid}`;
                navigator.clipboard.writeText(emergencyUrl).then(() => {
                    alert(lang === 'ar' ? "โ ุชู ูุณุฎ ุงูุฑุงุจุท!" : "โ Link copied!");
                });
            }
        });

        // 5. ุชุตุฏูุฑ ุงูุจูุงูุงุช
        document.getElementById('exportBtn').onclick = () => {
            const name = document.getElementById('userName').value;
            const content = `LifeBand Medical Profile\nName: ${name}\nID: ${document.getElementById('userIdNo').value}\nBlood: ${document.getElementById('userBlood').value}`;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `LifeBand_${name}.txt`;
            a.click();
        };
    </script>
</body>
</html>