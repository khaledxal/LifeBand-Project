<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeBand - Admin Panel</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-layout { display: flex; min-height: 100vh; gap: 20px; padding: 20px; }
        .sidebar { width: 250px; background: var(--glass); backdrop-filter: blur(10px); border-radius: 20px; padding: 20px; border: 1px solid var(--glass-border); }
        .main-content { flex: 1; }
        .report-card { background: var(--glass); padding: 20px; border-radius: 15px; margin-bottom: 15px; border-right: 5px solid var(--primary); transition: 0.3s; }
        .status-done { color: #10b981; font-weight: bold; }
        .status-pending { color: #f59e0b; font-weight: bold; }
        .btn-delete { background: #ef4444 !important; margin-right: 10px; width: auto; padding: 8px 15px; }
        
        /* Ø²Ø± Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ */
        .lang-toggle {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="page-fade">
    <div class="bg-animation"></div>
    
    <audio id="emergencySound" src="https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3" preload="auto"></audio>

    <div class="admin-layout">
        <aside class="sidebar">
            <h2 style="color: var(--primary); margin-bottom: 10px;" data-i18n="adm_title">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            
            <button id="langBtn" class="lang-toggle">EN</button>
            
            <nav>
                <a href="#" class="nav-item active" data-i18n="adm_nav_reports">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</a>
                <a href="index.html" class="nav-item" data-i18n="nav_home">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            </nav>
        </aside>

        <main class="main-content">
            <h1 style="margin-bottom: 20px;" data-i18n="adm_active_reports">Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h1>
            <div id="reportsList">
                <p data-i18n="adm_loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª...</p>
            </div>
        </main>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±Ø¬Ù…Ø© ---
        const translations = {
            ar: {
                adm_title: "Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
                adm_nav_reports: "ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª",
                nav_home: "ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
                adm_active_reports: "Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©",
                adm_loading: "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª...",
                adm_no_reports: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.",
                adm_patient: "Ø§Ù„Ù…Ø±ÙŠØ¶",
                adm_time: "Ø§Ù„ØªÙˆÙ‚ÙŠØª",
                adm_diagnosis: "Ø§Ù„ØªØ´Ø®ÙŠØµ",
                adm_status: "Ø§Ù„Ø­Ø§Ù„Ø©",
                adm_btn_confirm: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡",
                adm_btn_delete: "Ø­Ø°Ù",
                status_done: "ØªÙ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡",
                status_pending: "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
                confirm_done: "Ù‡Ù„ ØªÙ… Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ù„Ø§Ø²Ù…ØŸ",
                confirm_delete: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù„Ø§Øº Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ",
                lang_label: "EN"
            },
            en: {
                adm_title: "Admin Panel",
                adm_nav_reports: "ğŸ“‹ Reports List",
                nav_home: "ğŸ  Back to Home",
                adm_active_reports: "Active Reports",
                adm_loading: "Loading reports...",
                adm_no_reports: "No active reports currently.",
                adm_patient: "Patient",
                adm_time: "Time",
                adm_diagnosis: "Diagnosis",
                adm_status: "Status",
                adm_btn_confirm: "Confirm Action",
                adm_btn_delete: "Delete",
                status_done: "Done",
                status_pending: "Pending",
                confirm_done: "Has the necessary medical action been taken?",
                confirm_delete: "Are you sure you want to delete this report permanently?",
                lang_label: "AR"
            }
        };

        const reportsList = document.getElementById('reportsList');
        const alertAudio = document.getElementById('emergencySound');
        const langBtn = document.getElementById('langBtn');
        let firstLoad = true;
        let lastReportCount = 0;

        function setLanguage(lang) {
            const t = translations[lang];
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.innerText = t[key];
            });

            langBtn.innerText = t.lang_label;
            localStorage.setItem('preferred_lang', lang);
            // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ù†Ø¯Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ØºØ§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ±ÙˆØª
            renderReports(); 
        }

        langBtn.onclick = () => {
            const current = localStorage.getItem('preferred_lang') || 'ar';
            setLanguage(current === 'ar' ? 'en' : 'ar');
        };

        let currentData = {};

        const reportsRef = ref(db, 'reports');
        onValue(reportsRef, (snapshot) => {
            if (snapshot.exists()) {
                currentData = snapshot.val();
                const keys = Object.keys(currentData);
                
                if (!firstLoad && keys.length > lastReportCount) {
                    alertAudio.play().catch(e => console.log("Audio interaction needed"));
                }
                
                lastReportCount = keys.length;
                firstLoad = false;
                renderReports();
            } else {
                currentData = {};
                reportsList.innerHTML = `<p>${translations[localStorage.getItem('preferred_lang') || 'ar'].adm_no_reports}</p>`;
                lastReportCount = 0;
                firstLoad = false;
            }
        });

        function renderReports() {
            const lang = localStorage.getItem('preferred_lang') || 'ar';
            const t = translations[lang];
            const keys = Object.keys(currentData);
            
            if (keys.length === 0) return;

            reportsList.innerHTML = "";
            keys.reverse().forEach(key => {
                const report = currentData[key];
                const date = new Date(report.timestamp).toLocaleString(lang === 'ar' ? 'ar-SA' : 'en-US');
                const statusText = report.status === 'ØªÙ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡' ? t.status_done : t.status_pending;
                
                const card = document.createElement('div');
                card.className = 'report-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3>${t.adm_patient}: ${report.patientName}</h3>
                            <p style="font-size: 13px; opacity: 0.7;">${t.adm_time}: ${date}</p>
                            <p style="margin-top: 10px;"><b>${t.adm_diagnosis}:</b> ${report.diagnosis}</p>
                            <p>${t.adm_status}: <span class="${report.status === 'ØªÙ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡' ? 'status-done' : 'status-pending'}">${statusText}</span></p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            ${report.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' ? 
                                `<button onclick="markAsDone('${key}')" class="main-btn" style="width: auto; padding: 8px 15px; background: #10b981;">${t.adm_btn_confirm}</button>` : ''}
                            <button onclick="deleteReport('${key}')" class="main-btn btn-delete">${t.adm_btn_delete}</button>
                        </div>
                    </div>
                `;
                reportsList.appendChild(card);
            });
        }

        window.markAsDone = async (reportId) => {
            const lang = localStorage.getItem('preferred_lang') || 'ar';
            if(confirm(translations[lang].confirm_done)) {
                await update(ref(db, `reports/${reportId}`), { status: "ØªÙ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡" });
            }
        };

        window.deleteReport = async (reportId) => {
            const lang = localStorage.getItem('preferred_lang') || 'ar';
            if(confirm(translations[lang].confirm_delete)) {
                try {
                    await remove(ref(db, `reports/${reportId}`));
                } catch (err) {
                    alert(err.message);
                }
            }
        };

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        setLanguage(localStorage.getItem('preferred_lang') || 'ar');
    </script>
</body>
</html>