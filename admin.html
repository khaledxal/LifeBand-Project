<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>LifeBand - Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-layout { display: flex; min-height: 100vh; gap: 20px; padding: 20px; }
        .sidebar { width: 250px; background: var(--glass); backdrop-filter: blur(10px); border-radius: 20px; padding: 20px; border: 1px solid var(--glass-border); }
        .main-content { flex: 1; }
        .report-card { background: var(--glass); padding: 20px; border-radius: 15px; margin-bottom: 15px; border-right: 5px solid var(--primary); transition: 0.3s; }
        .status-done { color: #10b981; font-weight: bold; }
        .status-pending { color: #f59e0b; font-weight: bold; }
        .btn-delete { background: #ef4444; margin-right: 10px; width: auto; padding: 8px 15px; }
    </style>
</head>
<body class="page-fade">
    <div class="bg-animation"></div>
    
    <audio id="emergencySound" src="https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3" preload="auto"></audio>

    <div class="admin-layout">
        <aside class="sidebar">
            <h2 style="color: var(--primary); margin-bottom: 30px;">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            <nav>
                <a href="#" class="nav-item active">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</a>
                <a href="index.html" class="nav-item">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            </nav>
        </aside>

        <main class="main-content">
            <h1 style="margin-bottom: 20px;">Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h1>
            <div id="reportsList">
                <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª...</p>
            </div>
        </main>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const reportsList = document.getElementById('reportsList');
        const alertAudio = document.getElementById('emergencySound');
        let firstLoad = true;
        let lastReportCount = 0;

        const reportsRef = ref(db, 'reports');
        onValue(reportsRef, (snapshot) => {
            reportsList.innerHTML = "";
            if (snapshot.exists()) {
                const data = snapshot.val();
                const keys = Object.keys(data);
                
                // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø· (Ù„ÙŠØ³ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„)
                if (!firstLoad && keys.length > lastReportCount) {
                    alertAudio.play().catch(e => console.log("ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„ØµÙØ­Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª"));
                }
                
                lastReportCount = keys.length;
                firstLoad = false;

                keys.reverse().forEach(key => {
                    const report = data[key];
                    const date = new Date(report.timestamp).toLocaleString('ar-SA');
                    
                    const card = document.createElement('div');
                    card.className = 'report-card';
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h3>Ø§Ù„Ù…Ø±ÙŠØ¶: ${report.patientName}</h3>
                                <p style="font-size: 13px; opacity: 0.7;">Ø§Ù„ØªÙˆÙ‚ÙŠØª: ${date}</p>
                                <p style="margin-top: 10px;"><b>Ø§Ù„ØªØ´Ø®ÙŠØµ:</b> ${report.diagnosis}</p>
                                <p>Ø§Ù„Ø­Ø§Ù„Ø©: <span class="${report.status === 'ØªÙ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡' ? 'status-done' : 'status-pending'}">${report.status}</span></p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                ${report.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' ? 
                                    `<button onclick="markAsDone('${key}')" class="main-btn" style="width: auto; padding: 8px 15px; background: #10b981;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</button>` : ''}
                                <button onclick="deleteReport('${key}')" class="main-btn btn-delete">Ø­Ø°Ù</button>
                            </div>
                        </div>
                    `;
                    reportsList.appendChild(card);
                });
            } else {
                reportsList.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
                lastReportCount = 0;
                firstLoad = false;
            }
        });

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        window.markAsDone = async (reportId) => {
            if(confirm("Ù‡Ù„ ØªÙ… Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ù„Ø§Ø²Ù…ØŸ")) {
                await update(ref(db, `reports/${reportId}`), { status: "ØªÙ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡" });
            }
        };

        // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø¨Ù„Ø§Øº (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
        window.deleteReport = async (reportId) => {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù„Ø§Øº Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
                try {
                    await remove(ref(db, `reports/${reportId}`));
                } catch (err) {
                    alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: " + err.message);
                }
            }
        };
    </script>
</body>
</html>