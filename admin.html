<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeBand - Admin Panel</title>
    <link rel="stylesheet" href="style.css">
    <style>
        :root {
            --primary: #4f46e5; /* Ø£Ø²Ø±Ù‚ Ù…Ø´Ø¨Ø¹ Ø£ÙƒØ«Ø± Ù„Ù„ÙˆØ¶ÙˆØ­ */
            --secondary: #7c3aed;
            --text-dark: #111827; /* Ø£Ø³ÙˆØ¯ ÙƒØ±Ø¨ÙˆÙ†ÙŠ Ù„Ù„Ù†ØµÙˆØµ */
            --text-muted: #374151; /* Ø±Ù…Ø§Ø¯ÙŠ ØºØ§Ù…Ù‚ Ø¬Ø¯Ø§Ù‹ */
            --glass-border: rgba(0, 0, 0, 0.1);
        }

        .admin-layout { display: flex; min-height: 100vh; gap: 20px; padding: 20px; }

        /* Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± */
        .sidebar { 
            width: 280px; 
            background: #ffffff; /* Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ ØµØ±ÙŠØ­Ø© Ù„Ù„ÙˆØ¶ÙˆØ­ */
            border-radius: 20px; 
            padding: 25px; 
            border: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .sidebar nav {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        .sidebar .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            text-decoration: none;
            color: var(--text-dark);
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .sidebar .nav-item:hover {
            background: var(--primary);
            color: white;
            transform: translateX(-5px);
        }

        .sidebar .nav-item.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
        }

        /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª */
        .main-content { flex: 1; }

        .main-content h1 {
            font-size: 1.8rem;
            color: #1e1b4b; /* Ø£Ø²Ø±Ù‚ Ø¯Ø§ÙƒÙ† Ø¬Ø¯Ø§Ù‹ */
            margin-bottom: 30px;
            display: inline-block;
            border-bottom: 4px solid var(--primary);
            padding-bottom: 5px;
            font-weight: 800;
        }

        /* ÙƒØ±Øª Ø§Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø·ÙˆØ± Ø¨ÙˆØ¶ÙˆØ­ Ø¹Ø§Ù„ÙŠ */
        .report-card {
            background: #ffffff; /* Ø£Ø¨ÙŠØ¶ ØµØ±ÙŠØ­ */
            border: 2px solid #e5e7eb; /* Ø¥Ø·Ø§Ø± Ø£ÙˆØ¶Ø­ */
            border-radius: 15px; 
            padding: 25px; 
            margin-bottom: 25px; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: 0.3s;
        }

        .report-card:hover { transform: translateY(-3px); border-color: var(--primary); }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f3f4f6;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .patient-name { 
            font-size: 1.4rem; 
            font-weight: 900; 
            color: #1e1b4b; /* Ù„ÙˆÙ† Ø¯Ø§ÙƒÙ† Ø¬Ø¯Ø§Ù‹ Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ */
        }

        .report-time { 
            font-size: 0.95rem; 
            color: #4b5563; /* Ø±Ù…Ø§Ø¯ÙŠ ØºØ§Ù…Ù‚ Ø¬Ø¯Ø§Ù‹ */
            font-weight: 600;
            margin-top: 4px;
        }

        .diagnosis-box {
            background: #f8fafc; /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù†Øµ Ø§Ù„Ø¯Ø§ÙƒÙ† */
            padding: 20px; 
            border-radius: 12px; 
            border-right: 6px solid var(--primary);
            margin: 20px 0;
            color: var(--text-dark);
            font-size: 1.1rem;
            line-height: 1.7;
            font-weight: 500;
        }

        .diagnosis-box strong {
            color: #000000;
            font-weight: 800;
            font-size: 1.2rem;
        }

        .status-badge {
            padding: 8px 18px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 900;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .status-pending { background: #ffedd5; color: #9a3412; } /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ø¯Ø§ÙƒÙ† */
        .status-done { background: #dcfce7; color: #166534; }    /* Ø£Ø®Ø¶Ø± Ø¯Ø§ÙƒÙ† */

        .action-btns { display: flex; gap: 12px; justify-content: flex-end; }
        
        .btn-main {
            padding: 10px 24px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 800;
            transition: 0.2s;
            font-size: 1rem;
        }

        .btn-confirm { background: #059669; color: white; }
        .btn-delete { background: #dc2626; color: white; }
        .btn-main:hover { filter: brightness(1.1); transform: scale(1.05); }

        .lang-toggle {
            background: #f3f4f6;
            border: 2px solid #d1d5db;
            color: var(--text-dark);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: 800;
            transition: 0.3s;
        }
    </style>
</head>
<body class="page-fade" style="background-color: #f1f5f9;"> <audio id="emergencySound" src="https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3" preload="auto"></audio>

    <div class="admin-layout">
        <aside class="sidebar">
            <h2 data-i18n="adm_title" style="color: var(--primary); font-weight: 900;">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            <button id="langBtn" class="lang-toggle">EN</button>
            <nav>
                <a href="#" class="nav-item active" data-i18n="adm_nav_reports">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</a>
                <a href="index.html" class="nav-item" data-i18n="nav_home">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            </nav>
        </aside>

        <main class="main-content">
            <h1 data-i18n="adm_active_reports">Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h1>
            <div id="reportsList">
                </div>
        </main>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const translations = {
            ar: {
                adm_title: "Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
                adm_nav_reports: "ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª",
                nav_home: "ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
                adm_active_reports: "Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©",
                adm_loading: "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª...",
                adm_no_reports: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.",
                adm_patient: "Ø§Ù„Ù…Ø±ÙŠØ¶",
                adm_time: "Ø§Ù„ØªÙˆÙ‚ÙŠØª",
                adm_diagnosis: "Ø§Ù„ØªØ´Ø®ÙŠØµ",
                adm_status: "Ø§Ù„Ø­Ø§Ù„Ø©",
                adm_btn_confirm: "ØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø­Ø§Ù„Ø©",
                adm_btn_delete: "Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ",
                status_done: "ØªÙ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡",
                status_pending: "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
                confirm_done: "Ù‡Ù„ ØªÙ… Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ù„Ø§Ø²Ù…ØŸ",
                confirm_delete: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù„Ø§ØºØŸ",
                lang_label: "EN"
            },
            en: {
                adm_title: "Admin Panel",
                adm_nav_reports: "ğŸ“‹ Reports List",
                nav_home: "ğŸ  Back to Home",
                adm_active_reports: "Active Reports",
                adm_loading: "Loading reports...",
                adm_no_reports: "No active reports.",
                adm_patient: "Patient",
                adm_time: "Time",
                adm_diagnosis: "Diagnosis",
                adm_status: "Status",
                adm_btn_confirm: "Mark as Done",
                adm_btn_delete: "Delete",
                status_done: "Done",
                status_pending: "Pending",
                confirm_done: "Has medical action been taken?",
                confirm_delete: "Are you sure you want to delete this?",
                lang_label: "AR"
            }
        };

        const reportsList = document.getElementById('reportsList');
        const alertAudio = document.getElementById('emergencySound');
        const langBtn = document.getElementById('langBtn');
        let currentData = {};
        let firstLoad = true;
        let lastReportCount = 0;

        function setLanguage(lang) {
            const t = translations[lang];
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(t[key]) el.innerText = t[key];
            });

            langBtn.innerText = t.lang_label;
            localStorage.setItem('preferred_lang', lang);
            renderReports(); 
        }

        langBtn.onclick = () => {
            const current = localStorage.getItem('preferred_lang') || 'ar';
            setLanguage(current === 'ar' ? 'en' : 'ar');
        };

        const reportsRef = ref(db, 'reports');
        onValue(reportsRef, (snapshot) => {
            if (snapshot.exists()) {
                currentData = snapshot.val();
                const keys = Object.keys(currentData);
                if (!firstLoad && keys.length > lastReportCount) {
                    alertAudio.play().catch(e => console.log("Audio play blocked"));
                }
                lastReportCount = keys.length;
                firstLoad = false;
                renderReports();
            } else {
                currentData = {};
                reportsList.innerHTML = `<p style="color:black; font-weight:bold;">${translations[localStorage.getItem('preferred_lang') || 'ar'].adm_no_reports}</p>`;
                firstLoad = false;
            }
        });

        function renderReports() {
            const lang = localStorage.getItem('preferred_lang') || 'ar';
            const t = translations[lang];
            const keys = Object.keys(currentData);
            if (keys.length === 0) return;

            reportsList.innerHTML = "";
            keys.reverse().forEach(key => {
                const report = currentData[key];
                const date = new Date(report.timestamp).toLocaleString(lang === 'ar' ? 'ar-SA' : 'en-US');
                const isDone = report.status === 'ØªÙ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡';
                
                const card = document.createElement('div');
                card.className = 'report-card';
                card.innerHTML = `
                    <div class="report-header">
                        <div>
                            <div class="patient-name">${t.adm_patient}: ${report.patientName}</div>
                            <div class="report-time">${t.adm_time}: ${date}</div>
                        </div>
                        <span class="status-badge ${isDone ? 'status-done' : 'status-pending'}">
                            ${isDone ? t.status_done : t.status_pending}
                        </span>
                    </div>
                    <div class="diagnosis-box">
                        <strong>${t.adm_diagnosis}:</strong><br>
                        ${report.diagnosis}
                    </div>
                    <div class="action-btns">
                        ${!isDone ? `<button onclick="markAsDone('${key}')" class="btn-main btn-confirm">${t.adm_btn_confirm}</button>` : ''}
                        <button onclick="deleteReport('${key}')" class="btn-main btn-delete">${t.adm_btn_delete}</button>
                    </div>
                `;
                reportsList.appendChild(card);
            });
        }

        window.markAsDone = async (id) => {
            const lang = localStorage.getItem('preferred_lang') || 'ar';
            if(confirm(translations[lang].confirm_done)) {
                await update(ref(db, `reports/${id}`), { status: "ØªÙ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡" });
            }
        };

        window.deleteReport = async (id) => {
            const lang = localStorage.getItem('preferred_lang') || 'ar';
            if(confirm(translations[lang].confirm_delete)) {
                await remove(ref(db, `reports/${id}`));
            }
        };

        setLanguage(localStorage.getItem('preferred_lang') || 'ar');
    </script>
</body>
</html>